"use strict";angular.module("cahierDeTexteApp").service("User",["$http","APP_PATH",function(e,t){this.get_user=_.memoize(function(){return e.get(t+"/api/v0/users/current").success(function(e){return e.profil_actif=e.profils[0],e.is=function(e){return this.profil_actif.type==e},e.profil_actif.classes=_(e.classes).filter(function(t){return t.etablissement_code==e.profil_actif.uai}),e})})}]),angular.module("cahierDeTexteApp").factory("Classes",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/etablissements/:uai/classes/:id",{uai:"@uai",id:"@id"})}]),angular.module("cahierDeTexteApp").factory("Cours",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/cours/:id",{id:"@id"},{update:{method:"PUT"},valide:{method:"PUT",url:t+"/api/v0/cours/:id/valide"},copie:{method:"PUT",url:t+"/api/v0/cours/:id/copie/regroupement/:regroupement_id/creneau_emploi_du_temps/:creneau_emploi_du_temps_id",params:{id:"@id",regroupement_id:"@regroupement_id",creneau_emploi_du_temps_id:"@creneau_emploi_du_temps_id"}}})}]),angular.module("cahierDeTexteApp").factory("CreneauEmploiDuTemps",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/creneaux_emploi_du_temps/:id",{id:"@id",regroupement_id:"@regroupement_id",jour_de_la_semaine:"@jour_de_la_semaine",heure_debut:"@heure_debut",heure_fin:"@heure_fin",matiere_id:"@matiere_id"},{update:{method:"PUT"},"delete":{method:"DELETE",url:t+"/api/v0/creneaux_emploi_du_temps/:id",params:{id:"@id",date_creneau:"@date_creneau"}}})}]),angular.module("cahierDeTexteApp").factory("Devoirs",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/devoirs/:id",{id:"@id"},{update:{method:"PUT"},fait:{method:"PUT",url:t+"/api/v0/devoirs/:id/fait"}})}]),angular.module("cahierDeTexteApp").factory("EmploisDuTemps",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/emplois_du_temps/du/:debut/au/:fin",{debut:"@debut",fin:"@fin",uai:"@uai"})}]),angular.module("cahierDeTexteApp").factory("Enseignants",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/etablissements/:uai/enseignants/:enseignant_id",{uai:"@uai",enseignant_id:"@enseignant_id"})}]),angular.module("cahierDeTexteApp").factory("TypesDeDevoir",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/types_de_devoir/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").factory("PlagesHoraires",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/plages_horaires/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").service("API",["Classes","Cours","CreneauEmploiDuTemps","Devoirs","EmploisDuTemps","Enseignants","TypesDeDevoir","PlagesHoraires",function(e,t,i,n,a,r,s,u){this.query_classes=function(t){return e.query(t)},this.query_types_de_devoir=_.memoize(function(){return s.query()}),this.get_type_de_devoir=_.memoize(function(e){return s.get(e)}),this.query_emplois_du_temps=function(){return a.query()},this.get_creneau_emploi_du_temps=function(e){return i.get(e)},this.query_enseignants=function(e){return r.query(e)},this.get_enseignant=function(e){return r.get(e)},this.get_cours=function(e){return t.get(e)},this.query_devoirs=function(e){return n.query(e)},this.get_devoir=function(e){return n.get(e)},this.query_plages_horaires=function(){return u.query()},this.get_plage_horaire=function(e){return u.get(e)}}]),angular.module("cahierDeTexteApp").factory("Matieres",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/annuaire/matieres/:matiere_id",{matiere_id:"@matiere_id"})}]),angular.module("cahierDeTexteApp").factory("Regroupements",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/annuaire/regroupements/:regroupement_id",{regroupement_id:"@regroupement_id"})}]),angular.module("cahierDeTexteApp").factory("Users",["$resource","APP_PATH",function(e,t){return e(t+"/api/v0/annuaire/users/:user_id",{user_id:"@user_id"})}]),angular.module("cahierDeTexteApp").service("Annuaire",["Matieres","Regroupements","Users",function(e,t,i){this.get_matiere=_.memoize(function(t){return e.get({matiere_id:t})}),this.get_regroupement=_.memoize(function(e){return t.get({regroupement_id:e})}),this.get_user=_.memoize(function(e){return i.get({user_id:e})})}]),angular.module("cahierDeTexteApp").service("Documents",["$http","DOCS_URL",function(e,t){this.list_files=function(i){return i="undefined"==typeof i?"&init=1":i,e.get(t+"/api/connector?cmd=open&target="+i)},this.ajout_au_cahier_de_textes=function(i,n){return e.get(t+"/api/ctxt/copy?cmd=paste&targets[]="+n+"&cut=0&attachment=CAHIERTXT&share="+i)},this.upload_dans_cahier_de_textes=function(i,n){for(var a=[],r=0;r<n.length;r++){var s=new FormData;s.append("upload[]",n.item(r)),s.append("id","upload"),s.append("cmd","upload"),s.append("current",0),s.append("attachment","CAHIERTXT"),s.append("share",i),a.push(e.post(t+"/api/ctxt/add",s,{headers:{"Content-Type":void 0},transformRequest:angular.identity}))}return a}}]),angular.module("cahierDeTexteApp").service("Redirection",["$location","$state","User",function(e,t,i){this.doorman=function(n){i.get_user().then(function(i){if(0===_(n).size()||-1===_(n).indexOf(i.data.profil_actif.type)&&!i.data.profil_actif.admin){var a=!0,r="";switch(i.data.profil_actif.type){case"DIR":r="principal.enseignants";break;case"ENS":r="enseignant.emploi_du_temps";break;case"ELV":r="eleve.emploi_du_temps";break;default:e.url("/logout"),e.replace()}a="index"==t.current.name||t.current.name==r?!0:!1,t.transitionTo(r,t.params,{reload:a,inherit:!1,notify:a})}})}}]),angular.module("cahierDeTexteApp").controller("EleveDevoirsCtrl",["$scope","API","Devoirs",function(e,t,i){e.empty=!1,e.affiche_faits=!1,e.fait=function(t){i.fait({id:t}).$promise.then(function(){_(e.devoirs).findWhere({id:t}).fait=!0})},e.filtre=function(){e.devoirs=e.affiche_faits?e.all_devoirs:_(e.all_devoirs).reject(function(e){return e.fait})},t.query_types_de_devoir().$promise.then(function(i){t.query_devoirs().$promise.then(function(t){e.all_devoirs=_(t).map(function(e){return e.type_devoir=_(i).findWhere({id:e.type_devoir_id}).label,e}),e.filtre(),e.empty=0==e.all_devoirs.length})})}]),angular.module("cahierDeTexteApp").controller("IndexCtrl",["Redirection",function(e){e.doorman([])}]),angular.module("cahierDeTexteApp").controller("PrincipalEnseignantsCtrl",["$scope","$locale","THEME","$q","API","Annuaire","User","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,i,n,a,r,s,u,l){e.annee=t.DATETIME_FORMATS.MONTH,e.classe=null,e.mois=null,e.classes={},e.details_enseignants={},e.pieChart=u(),e.barChart=l(),e.pieChart.populate=function(t){e.pieChart.data=[{label:"saisies",value:t.filled-t.validated},{label:"visas",value:t.validated}]},e.barChart.populate=function(t){var i={key:"saisies",values:[]},n={key:"visas",values:[]};_(t).each(function(t){i.values.push([e.details_enseignants[t.enseignant_id].full_name,t.filled]),n.values.push([e.details_enseignants[t.enseignant_id].full_name,t.validated])}),e.barChart.data=[n,i]},e.htmlify_classes_list=function(e){return"Classes : <ul><li>"+_(e).map(function(e){return e.classe_libelle}).join("</li><li>")+"</li></ul>"},e.htmlify_matieres_list=function(e){return"Matières : <ul><li>"+e.join("</li><li>")+"</li></ul>"},e.individualCharts={enseignants:[],populate:function(t,i){e.individualCharts.enseignants=_(t).map(function(e){var t={enseignant:i[e.enseignant_id],pieChart:u()};return t.pieChart.data=[{label:"visas",value:e.validated},{label:"saisies",value:e.filled-e.validated}],t})}},e.extract_classes_promises=function(e){return _.chain(e).pluck("classes").flatten().pluck("regroupement_id").uniq().reject(function(e){return""===e}).map(function(e){return r.get_regroupement(e).$promise}).value()},e.extract_details_enseignants_promises=function(e){return _(e).pluck("enseignant_id").map(function(e){return r.get_user(e).$promise})},e.process_data=function(){if(void 0!==e.raw_data){if(e.displayed_data=e.raw_data,null!=e.classe){var t=_(e.classes).invert()[e.classe];e.displayed_data=_.chain(e.displayed_data).map(function(e){return{enseignant_id:e.enseignant_id,classes:_(e.classes).reject(function(e){return e.regroupement_id!=t})}}).reject(function(e){return 0===e.classes.length}).value()}null!=e.mois&&(e.displayed_data=_(e.displayed_data).map(function(t){return{enseignant_id:t.enseignant_id,classes:_(t.classes).map(function(t){return{regroupement:t.regroupement_id,statistiques:_(t.statistiques).reject(function(t){return t.month!=e.mois})}})}})),e.displayed_data.filled=0,e.displayed_data.validated=0,_(e.displayed_data).each(function(t){var i=_(t.classes).reduce(function(e,t){var i=_(t.statistiques).reduce(function(e,t){return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});return{filled:e.filled+i.filled,validated:e.validated+i.validated}},{filled:0,validated:0});t.filled=i.filled,t.validated=i.validated,e.displayed_data.filled+=i.filled,e.displayed_data.validated+=i.validated}),e.pieChart.populate(e.displayed_data),e.individualCharts.populate(e.displayed_data,e.details_enseignants),e.barChart.populate(e.displayed_data)}},s.get_user().then(function(t){var i=t.data;a.query_enseignants({uai:i.profil_actif.uai}).$promise.then(function(t){e.raw_data=_(t).reject(function(e){return""===e.enseignant_id}),n.all(e.extract_details_enseignants_promises(e.raw_data)).then(function(t){_(t).each(function(t){t.matieres=_.chain(t.classes).pluck("matiere_libelle").uniq().value(),e.details_enseignants[t.id_ent]=t}),n.all(e.extract_classes_promises(e.raw_data)).then(function(t){_(t).each(function(t){e.classes[t.id]=null!==t.libelle?t.libelle:t.libelle_aaf}),e.process_data()})})})})}]),angular.module("cahierDeTexteApp").controller("EmploiDuTempsPopupDisplayCtrl",["$scope","$modalInstance","Devoirs","titre","cours","devoirs",function(e,t,i,n,a,r){var s=e;s.titre=n,s.cours=a,s.devoirs=r,s.fait=function(e){i.fait({id:e},function(){_(r).findWhere({id:e}).fait=!0})},s.fermer=function(){t.close(s)}}]),angular.module("cahierDeTexteApp").controller("EmploiDuTempsCtrl",["$scope","$modal","$q","$filter","CALENDAR_OPTIONS","CALENDAR_PARAMS","API","Annuaire","EmploisDuTemps","User","CreneauEmploiDuTemps",function(e,t,i,n,a,r,s,u,l,d,o){var c=angular.identity,p=[],f=[],m=[];e.creneau_selectionne={};var h=function(i,n,a){t.open({templateUrl:"app/views/eleve/detail_emploi_du_temps.html",controller:"EmploiDuTempsPopupDisplayCtrl",resolve:{titre:function(){return i},cours:function(){return n},devoirs:function(){return a}}}).result.then(function(t){_(t.devoirs).each(function(t){_(e.calendar.events[0]).findWhere({type:"devoir",id:t.id}).className=t.fait?" saisie-devoirs-fait":" saisie-devoirs"}),e.emploi_du_temps.fullCalendar("renderEvent",e.creneau_selectionne)})},v=function(e,i,n,a,r,s,u,l){t.open({templateUrl:"app/views/enseignant/edition_emploi_du_temps.html",controller:"EmploiDuTempsPopupEditionCtrl",resolve:{raw_data:function(){return e},types_de_devoir:function(){return i},matieres:function(){return n},classes:function(){return a},creneau_selectionne:function(){return r},cours:function(){return s},devoirs:function(){return u}}}).result.then(function(e){e.devoirs=_(e.devoirs).filter(function(e){return _(e).has("id")}),l(e)})},g=function(t,i){var n=this;this.details={cours:t.cours,devoirs:t.devoirs,cahier_de_textes_id:t.cahier_de_textes_id,regroupement_id:t.regroupement_id,enseignant_id:t.enseignant_id,matiere_id:t.matiere_id,creneau_emploi_du_temps_id:i.creneau_emploi_du_temps_id},this.allDay=!1,this.title="",this.description="",this.regroupement=_(e.classes).findWhere({id:parseInt(this.details.regroupement_id)}),this.type=_(i).has("fait")?"devoir":"cours",this.has_resources=_(i).has("ressources")&&i.ressources.length>0,"cours"===this.type?(i.start=t.start,i.end=t.end,this.className=null===i.date_validation?"saisie-invalide":"saisie-valide",t.matiere_id.length>0&&u.get_matiere(t.matiere_id).$promise.then(function(e){n.title+=e.libelle_long})):(this.className=i.fait?"saisie-devoirs-fait":"saisie-devoirs",s.get_type_de_devoir({id:i.type_devoir_id}).$promise.then(function(e){n.title+=e.label})),this.start=new Date(i.start),this.end=new Date(i.end),_(i).has("contenu")&&i.contenu.length>0?(this.description+='<br><span style="color:'+r.couleurs[this.type]+'">',this.description+=i.contenu.substring(0,r.max_length),this.description+=i.contenu.length>r.max_length?"…":"",this.description+="</span>",this.id=i.id):this.className="saisie-vide",this.className+="ELV"===e.current_user.profil_actif.type&&_(i).has("contenu")&&i.contenu.length>0||"ENS"===e.current_user.profil_actif.type&&this.details.enseignant_id===e.current_user.uid?" clickable-event":" unclickable-event"},y=function(e){var t=[];return t.push(new g(e,e.cours)),_(e.devoirs).each(function(i){t.push(new g(e,i))}),t};e.calendar={options:a,events:[]},d.get_user().then(function(t){e.current_user=t.data;var a=function(t){var i=_.chain(t).map(function(e){return y(e)}).flatten().value();e.calendar.events[0]=_(i).filter(function(e){return"cours"===e.type}),e.calendar.events[1]=_(i).filter(function(e){return"devoir"===e.type})};e.refresh_calendar=function(){a(c(e.raw_data))};var r=function(t,i){l.query({debut:t,fin:i,uai:e.current_user.profil_actif.uai},function(t){e.raw_data=t,e.refresh_calendar()})};switch(e.calendar.options.viewRender=function(e){r(e.visStart,e.visEnd)},e.current_user.profil_actif.type){case"ENS":e.uniquement_mes_creneaux=!0,e.calendar.options.selectable=!0,e.calendar.options.editable=!0;var d=function(e){return _.chain(e.profil_actif.classes).reject(function(t){return t.etablissement_code!==e.profil_actif.uai}).pluck("regroupement_id").uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return u.get_regroupement(e)}).value()},g=function(e){return _.chain(e.classes).reject(function(t){return t.etablissement_code!==e.profil_actif.uai||void 0===t.matiere_enseignee_id}).pluck("matiere_enseignee_id").uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return[e,u.get_matiere(e)]}).object().value()},T=function(e){return _.chain(e).pluck("matiere_id").uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return[e,u.get_matiere(e)]}).object().value()};p=s.query_types_de_devoir(),f=T(e.current_user),m=g(e.current_user),e.classes=d(e.current_user);var b=function(){var t=e.emploi_du_temps.fullCalendar("getView");r(t.visStart,t.visEnd)};e.calendar.options.eventClick=function(t){if(t.details.enseignant_id===e.current_user.uid){t.id=t.details.creneau_emploi_du_temps_id,t.heure_debut=t.start,t.heure_fin=t.end,t.matiere_id=t.details.matiere_id,t.regroupement_id=t.details.regroupement_id;var n=null,a=[];void 0!==t.details.cours.id?(n=s.get_cours({id:t.details.cours.id}),n.create=!1,i.all(n,p,f,e.classes).then(function(){t.details.devoirs.length>0&&(_(t.details.devoirs).each(function(){s.get_devoir({id:t.details.devoirs[0].id}).$promise.then(function(e){a.push(e)})}),a.create=!1)})):n=null,v(e.raw_data,p,m,e.classes,t,n,a,b)}},e.calendar.options.select=function(t,i){t=n("correctTimeZone")(t),i=n("correctTimeZone")(i);var a=new o({regroupement_id:null===e.classe?"":""+e.classe,jour_de_la_semaine:t.getDay()+1,heure_debut:new Date(new Date(t)).toISOString(),heure_fin:new Date(new Date(i)).toISOString(),matiere_id:""});a.$save().then(function(){a.dirty=!0,a.heure_debut=t,a.heure_fin=i,a.regroupement_id=null===e.classe?void 0:""+e.classe,a.cahier_de_textes_id=e.classes[0].cahier_de_textes_id,v(e.raw_data,p,m,e.classes,a,null,[],b),e.emploi_du_temps.fullCalendar("unselect")})},e.calendar.options.eventRender=function(e,t){var i=t.find(".fc-event-title");i.append(" - "+e.regroupement.libelle+"<br>"+e.description),e.has_resources&&i.prepend('<i class="glyphicon glyphicon-paperclip"></i>')},c=function(t){var i=t;return null!=e.classe&&(i=_(e.raw_data).filter(function(t){return t.regroupement_id==e.classe})),e.uniquement_mes_creneaux&&(i=_(i).filter(function(t){return t.enseignant_id===e.current_user.uid})),i};break;case"ELV":default:e.calendar.options.eventRender=function(e,t){html_element=t.find(".fc-event-title"),html_element.append(e.description),e.has_resources&&html_element.prepend('<i class="glyphicon glyphicon-paperclip"></i>')},e.calendar.options.eventClick=function(t){_(t.details.cours).has("contenu")&&(e.creneau_selectionne=t,h(t.title,t.details.cours,t.details.devoirs))}}})}]),angular.module("cahierDeTexteApp").controller("PrincipalClassesCtrl",["$scope","THEME","$locale","$q","API","Annuaire","User","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,i,n,a,r,s,u,l){e.empty=!1,s.get_user().then(function(t){var s=t.data;e.raw_data=[],e.displayed_data=[],e.classes={},e.matieres=[],e.annee=i.DATETIME_FORMATS.MONTH,e.classe=null,e.moisCourant=null,e.matiereCourante=null,e.global_stats={filled:0,validated:0},e.pieChart=u(),e.barChart=l(),e.pieChart.populate=function(t){e.pieChart.data=[{label:"saisie",value:t.filled-t.validated},{label:"valide",value:t.validated}]},e.barChart.populate=function(t){var i=[];_(12).times(function(t){i.push([e.annee[t],0])});var n=t.reduce(function(e,t){return _(12).times(function(i){e.filled[i][1]+=t.mensuel.filled[i],e.validated[i][1]+=t.mensuel.validated[i]}),e},{filled:angular.copy(i),validated:angular.copy(i)});e.barChart.data.push({key:"saisie",values:n.filled}),e.barChart.data.push({key:"valide",values:n.validated})},e.individualCharts={classes:[],populate:function(t,i){var n=_.chain(i).map(function(e){return[e.id,e]}).object().value();e.individualCharts.classes=_(t).map(function(e){var t={regroupement:n[e.regroupement_id],pieChart:u()};return t.pieChart.data=[{label:"saisie",value:e.filled-e.validated},{label:"valide",value:e.validated}],t})}},e.extract_matieres=function(e){return _.chain(e).pluck("matieres").flatten().pluck("matiere_id").uniq().compact().map(function(e){var t={id:e,libelle:"Matière inconnue !"};return r.get_matiere(e).$promise.then(function(e){t.libelle=e.libelle_long}),t}).value()},e.extract_classes=function(e){return _.chain(e).pluck("regroupement_id").map(function(e){return r.get_regroupement(e).$promise}).value()},e.process_data=function(){if(e.raw_data.length>0){e.displayed_data=e.raw_data,null!=e.classe&&(e.displayed_data=_(e.raw_data).filter(function(t){return t.regroupement_id==""+e.classe})),null!=e.matiereCourante&&(e.displayed_data=e.displayed_data.map(function(t){var i=_(t.matieres).filter(function(t){return t.matiere_id==e.matiereCourante});return{regroupement_id:t.regroupement_id,matieres:i}})),null!=e.moisCourant&&(e.displayed_data=e.displayed_data.map(function(t){return{regroupement_id:t.regroupement_id,matieres:t.matieres.map(function(t){return{matiere_id:t.matiere_id,mois:_(t.mois).filter(function(t){return t.mois==e.moisCourant})}})}})),_(e.displayed_data).each(function(e){e.mensuel=e.matieres.reduce(function(e,t){return _(t.mois).each(function(t){e.filled[t.mois-1]+=t.filled,e.validated[t.mois-1]+=t.validated}),e},{filled:[0,0,0,0,0,0,0,0,0,0,0,0],validated:[0,0,0,0,0,0,0,0,0,0,0,0]}),e.filled=e.mensuel.filled.reduce(function(e,t){return e+t},0),e.validated=e.mensuel.validated.reduce(function(e,t){return e+t},0)});var t=e.displayed_data.reduce(function(e,t){return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});e.displayed_data.filled=t.filled,e.displayed_data.validated=t.validated,e.individualCharts.populate(e.displayed_data,e.classes),e.pieChart.populate(e.displayed_data),e.barChart.populate(e.displayed_data)}},a.query_classes({uai:s.profil_actif.uai}).$promise.then(function(t){e.raw_data=t,e.empty=0==_(e.raw_data[0]).size(),e.empty||n.all(e.extract_matieres(e.raw_data)).then(function(t){e.matieres=t,n.all(e.extract_classes(e.raw_data)).then(function(t){e.classes=t,e.process_data()})})})})}]),angular.module("cahierDeTexteApp").controller("EmploiDuTempsPopupEditionCtrl",["$scope","$filter","$q","TINYMCE_OPTIONS","$modalInstance","Documents","CreneauEmploiDuTemps","Cours","Devoirs","cours","devoirs","types_de_devoir","creneau_selectionne","raw_data","classes","matieres",function(e,t,i,n,a,r,s,u,l,d,o,c,p,f,m,h){var v=e,g=function(e){var t=new u({cahier_de_textes_id:e.cahier_de_textes_id,creneau_emploi_du_temps_id:e.id,date_cours:new Date(e.heure_debut).toISOString(),date_validation:null});return t.create=!0,t};v.tinyMCEOptions=n,null===d?v.cours=g(p):(v.cours=d,v.cours.create=!1),v.devoirs=o,v.types_de_devoir=c,v.creneau_selectionne=p,v.matieres=h,v.classes=m,v.creneau_en_creation=0==v.creneau_selectionne.matiere_id.length||void 0===v.creneau_selectionne.regroupement_id,v.creneau_en_creation&&(v.creneau_tmp_heure_debut=t("correctTimeZoneToGMT")(v.creneau_selectionne.heure_debut),v.creneau_tmp_heure_fin=t("correctTimeZoneToGMT")(v.creneau_selectionne.heure_fin)),v.matiere_id=v.creneau_selectionne.matiere_id.length>0?v.creneau_selectionne.matiere_id:_.chain(v.matieres).values().first().value().id,v.regroupement_id="undefined"!==v.creneau_selectionne.regroupement_id?parseInt(v.creneau_selectionne.regroupement_id):_(v.classes).first().id,v.classe=_(v.classes).findWhere({id:parseInt(v.regroupement_id)}),v.matiere=v.matieres[v.matiere_id],v.ouvre_sequence_pedagogique=!v.cours.create,v.dirty=!1,v.deleted=!1,v.creneau_deleted=!1,v.is_dirty=function(e){v.dirty=null===e||null!==e&&e.contenu.length>0?!0:!1},v.estimation_over=function(e,t){e.overValue=t,e.minutes=5*t},v.estimation_leave=function(e){v.estimation_over(e,e.temps_estime)},_(v.devoirs).each(function(e){v.estimation_leave(e)}),v.set_creneau_date_due=function(e){var t=_(v.creneaux_devoirs_possibles).findWhere({date_due:e.date_due});e.creneau_emploi_du_temps_id=t.creneau_emploi_du_temps_id,v.is_dirty()},v.erreurs=[],v.scope=v,v.creneaux_similaires=_.chain(f).filter(function(e){return e.regroupement_id!=v.regroupement_id&&e.matiere_id==v.matiere_id}).map(function(e){return e.classe=_(v.classes).findWhere({id:parseInt(e.regroupement_id)}),e.label_sbox=t("formateCreneau")(e),e}).value(),v.creneaux_similaires.selected=[];var y=_.chain(f).filter(function(e){return e.regroupement_id==v.regroupement_id&&e.matiere_id==v.matiere_id}).map(function(e){return e.classe=_(v.classes).findWhere({id:parseInt(e.regroupement_id)}),e.date_due=t("date")(e.start,"y-MM-dd"),e.label_sbox=t("formateCreneau")(e.start),e.semaine="cette semaine",e}).sortBy(function(e){return e.start}).value(),T=[],b=4;_(b+1).times(function(e){_(y).each(function(i){var n=angular.copy(i),a=new Date(n.start);a.setDate(a.getDate()+7*e);var r=new Date(n.end);r.setDate(r.getDate()+7*e),n.start=a.toISOString(),n.end=r.toISOString(),n.semaine=0==e?"cette semaine":"dans "+e+" semaine",n.semaine+=e>1?"s":"",n.date_due=t("date")(n.start,"y-MM-dd"),n.label_sbox=t("formateCreneau")(n),T.push(n)})}),v.creneaux_devoirs_possibles=T,v.cartable=[],r.list_files().success(function(e){v.cartable=e,v.cartable.files=_.chain(v.cartable.files).rest().value().map(function(e){return e.children=[],e})}),v.add_ressource=function(e,t,i){void 0===e.ressources&&(e.ressources=[]),void 0===_(e.ressources).findWhere({hash:i})&&r.ajout_au_cahier_de_textes(v.classe.id,i).success(function(i){e.ressources.push({name:t,hash:_(i.added).first().hash}),v.is_dirty()})},v.upload_and_add_ressource=function(e,t){void 0===e.ressources&&(e.ressources=[]);for(var i=r.upload_dans_cahier_de_textes(v.classe.id,t),n=0;n<i.length;n++)i[n].success(function(t){_(t.added).each(function(t){void 0===_(e.ressources).findWhere({hash:t.hash})&&(e.ressources.push({name:t.name,hash:t.hash}),v.is_dirty())})}).error(function(e){console.debug(e.error)})},v.remove_ressource=function(e,t){e.ressources=_(e.ressources).reject(function(e){return e.hash==t}),v.is_dirty()},v.treeClicked=function(e){"directory"===e.mime&&r.list_files(e.hash).then(function(t){_.chain(t.data.files).rest().each(function(t){t.children=[],e.children.push(t),v.selectNodeHead(e)})})},v.treeOptions={nodeChildren:"children",dirSelectable:!0},v.toggle_sequence_pedagogique=function(){v.ouvre_sequence_pedagogique=!v.ouvre_sequence_pedagogique},v.ajout_devoir=function(){var e=new l({cours_id:v.cours.id,date_due:t("date")(v.creneau_selectionne.start,"yyyy-MM-dd"),type_devoir_id:_(v.types_de_devoir).last().id,creneau_emploi_du_temps_id:v.creneau_selectionne.id});e.create=!0,v.devoirs.unshift(e)},v.dupliquer=function(){_(v.creneaux_similaires.selected).each(function(e){v.cours.$copie({regroupement_id:e.regroupement_id,creneau_emploi_du_temps_id:e.creneau_emploi_du_temps_id})})},v.fermer=function(){a.close(v)},v.effacer_cours=function(){v.cours.$delete().then(function(){_(v.devoirs).each(function(e){e.$delete()}),v.deleted=!0,v.fermer()})},v.effacer_devoir=function(e){e.$delete().then(function(){v.devoirs=_(v.devoirs).reject(function(e){return e.deleted})})},v.effacer_creneau=function(){s.delete({id:v.creneau_selectionne.id,date_creneau:e.cours.date_cours}).$promise.then(function(){v.fermer()})},v.annuler=function(){v.creneau_en_creation?v.effacer_creneau():(v.dirty=!1,v.fermer())},v.valider=function(){if(v.erreurs=[],""!==v.matiere_id&&""!==v.regroupement_id){v.creneau_en_creation&&(v.creneau_selectionne.matiere_id=v.matiere_id,v.creneau_selectionne.regroupement_id=v.regroupement_id,v.creneau_selectionne.heure_debut=t("correctTimeZone")(v.creneau_tmp_heure_debut),v.creneau_selectionne.heure_fin=t("correctTimeZone")(v.creneau_tmp_heure_fin),v.creneau_selectionne.$update());var e=i.when(!0);_(v.cours).has("contenu")&&v.cours.contenu.length>0&&(v.is_dirty(),v.cours.create?(v.cours.cahier_de_textes_id=_(v.classes).findWhere({id:v.regroupement_id}).cahier_de_textes_id,v.cours.creneau_emploi_du_temps_id=v.creneau_selectionne.id,e=v.cours.$save()):e=v.cours.$update()),e.then(function(e){var t=[];v.devoirs=_(v.devoirs).map(function(n){if(_(n).has("contenu")&&n.contenu.length>0){n.dirty=!0;var a=i.defer();n.create?(n.cours_id=e.id,n.$save().then(function(e){n.id=e.id,a.resolve(e)},function(e){v.erreurs.unshift({status:e.status,message:e.data.error}),a.reject(e)})):n.$update().then(function(e){n.id=e.id,a.resolve(e)},function(e){v.erreurs.unshift({status:e.status,message:e.data.error}),a.reject(e)}),t.push(a.promise)}return n}),i.all(t).then(function(){v.fermer()})})}else v.erreurs.push({message:"Aucune matière ou classe défini"})}}]),angular.module("cahierDeTexteApp").controller("EleveCtrl",["$scope","$state",function(e,t){e.tabs=[{heading:"Emploi du temps",uisref:"eleve.emploi_du_temps",active:!1},{heading:"Travail à faire",uisref:"eleve.devoirs",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name})}]),angular.module("cahierDeTexteApp").controller("PrincipalCtrl",["$scope","$state",function(e,t){e.tabs=[{heading:"Tableaux de bord par classe",uisref:"principal.classes",active:!1},{heading:"Validation des saisies par enseignant",uisref:"principal.enseignants",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name})}]),angular.module("cahierDeTexteApp").controller("FooterCtrl",["$scope","VERSION",function(e,t){console.debug(t),e.version=t}]),angular.module("cahierDeTexteApp").controller("EnseignantCtrl",["$scope","$state","User",function(e,t,i){e.tabs=[{heading:"Emploi du temps",uisref:"enseignant.emploi_du_temps",active:!1},{heading:"Statistiques",uisref:"enseignant.stats",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name}),i.get_user().success(function(t){e.current_user=t})}]),angular.module("cahierDeTexteApp").controller("StatsEnseignantCtrl",["$scope","$stateParams","$q","$locale","$sce","API","Cours","Annuaire","User","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,i,n,a,r,s,u,l,d,o){e.mois=n.DATETIME_FORMATS.MONTH,e.classe=null,e.moisCourant=null,e.gridSaisies=[],e.selectedSaisies=[],e.matieres={},e.classes={},e.montre_valides=!1;var c=function(e,t,i){var n=e;return null!=t&&(n=_(n).where({mois:t+1})),null!=i&&(n=_(n).where({regroupement_id:i.id})),n};e.grid={data:"gridSaisies",selectedItems:e.selectedSaisies,enableCellEdit:!1,plugins:[new ngGridFlexibleHeightPlugin],rowHeight:64,columnDefs:[{field:"classe",displayName:"Classe",cellTemplate:'<span data-ng-bind="classes[row.entity.regroupement_id].libelle"></span>'},{field:"matiere",displayName:"Matière",cellTemplate:'<span data-ng-bind="matieres[row.entity.matiere_id].libelle_long"></span>'},{field:"cours",displayName:"Cours",cellTemplate:'<span class="scrollbar" data-ng-bind-html="row.entity.cours.contenu"></span>'},{field:"devoir",displayName:"Travail à faire",cellTemplate:'<span class="scrollbar" data-ng-bind-html="row.entity.devoir.contenu"></span>'},{field:"validated",displayName:"Visée",cellTemplate:'<div class="ngSelectionCell"><i class="glyphicon glyphicon-ok-sign" data-ng-model="row.entity.valide" data-ng-show="row.entity.valide"></i><input tabindex="-1" class="ngSelectionCheckbox" type="checkbox" data-ng-model="row.entity.valide" data-ng-hide="row.entity.valide || current_user.is( \'ENS\' )" data-ng-click="grid.valide( row )" /></div>'}],valide:function(t){t.entity.cours.$valide(),t.entity.valide=!0,e.raw_data[t.entity.index].valide=!0,e.graphiques.populate(e.gridSaisies)},valideSelection:function(){_(e.selectedSaisies).each(function(t){t.cours.$valide(),t.valide=!0,e.raw_data[t.index].valide=!0}),e.graphiques.populate(e.gridSaisies)},selectionneNonValides:function(){_(e.gridSaisies).each(function(t,i){t.valide===!1&&e.grid.selectItem(i,!0)})},populate:function(t){e.gridSaisies=c(t,e.moisCourant,e.classe),e.montre_valides||(e.gridSaisies=_(e.gridSaisies).where({valide:!1}))}},e.graphiques={pieChart:d(),barChart:o(),populate:function(t){e.graphiques.barChart.data=[],e.graphiques.pieChart.data=[{label:"visas",value:0},{label:"saisies",value:0}];var i={key:"saisies",values:[]},n={key:"visas",values:[]};_.chain(c(t,e.moisCourant,e.classe)).groupBy("regroupement_id").each(function(t){var a=t.length,r=_(t).where({valide:!0}).length;i.values.push([e.classes[t[0].regroupement_id].libelle,a]),n.values.push([e.classes[t[0].regroupement_id].libelle,r]),e.graphiques.barChart.data=[n,i],e.graphiques.pieChart.data[0].value+=r,e.graphiques.pieChart.data[1].value+=a-r})}},e.process_data=function(){void 0!==e.raw_data&&(e.raw_data=_(e.raw_data).map(function(e,t){return e.index=t,e.cours=new s(e.cours),e}),e.grid.populate(e.raw_data),e.graphiques.populate(e.raw_data))},l.get_user().success(function(n){e.current_user=n,e.enseignant_id=t.enseignant_id,void 0===e.enseignant_id&&e.enseignant_id!=e.current_user.uid&&(e.enseignant_id=e.current_user.uid),u.get_user(e.enseignant_id).$promise.then(function(t){e.enseignant=t,e.enseignant.classes=_(e.current_user.profil_actif.classes).uniq(function(e){return e.classe_libelle}),e.enseignant.matieres=_(e.enseignant.classes).uniq(function(e){return e.matiere_enseignee_id}),e.enseignant.prof_principal=_.chain(e.enseignant.classes).filter(function(e){return"O"==e.prof_principal}).map(function(e){return e.classe_libelle}).value()}),r.get_enseignant({enseignant_id:e.enseignant_id,uai:e.current_user.profil_actif.uai}).$promise.then(function(t){var n=function(e,t,i){return _.chain(e).flatten().pluck(t).uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return i(e)}).object().value()};e.raw_data=t.saisies,e.matieres=n(e.raw_data,"matiere_id",function(e){return[e,u.get_matiere(e)]}),e.classes=n(e.raw_data,"regroupement_id",function(e){return[e,u.get_regroupement(e)]}),i.all(e.classes).then(function(){e.process_data()})})})}]),angular.module("cahierDeTexteApp").controller("HeaderCtrl",["$scope","$state","User","Redirection",function(e,t,i,n){e.embedded=window!=window.top,i.get_user().success(function(t){e.current_user=t}),e.reload=function(){n.doorman([])}}]);