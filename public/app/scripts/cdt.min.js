"use strict";angular.module("cahierDeTexteApp").service("Redirection",["$location","$state","User",function(e,i,t){this.doorman=function(a){t.get_user().then(function(t){if(-1==_(a).indexOf(t.data.profil_actif.type))switch(t.data.profil_actif.type){case"DIR":i.transitionTo("principal.enseignants");break;case"ENS":i.transitionTo("enseignant");break;case"ELV":i.transitionTo("eleve.emploi_du_temps");break;default:e.url("/logout"),e.replace()}})}}]),angular.module("cahierDeTexteApp").factory("Matieres",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/annuaire/matieres/:matiere_id",{matiere_id:"@matiere_id"})}]),angular.module("cahierDeTexteApp").factory("Regroupements",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/annuaire/regroupements/:regroupement_id",{regroupement_id:"@regroupement_id"})}]),angular.module("cahierDeTexteApp").factory("Users",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/annuaire/users/:user_id",{user_id:"@user_id"})}]),angular.module("cahierDeTexteApp").service("Annuaire",["Matieres","Regroupements","Users",function(e,i,t){this.get_matiere=_.memoize(function(i){return e.get({matiere_id:i})}),this.get_regroupement=_.memoize(function(e){return i.get({regroupement_id:e})}),this.get_user=_.memoize(function(e){return t.get({user_id:e})})}]),angular.module("cahierDeTexteApp").service("Documents",["$http",function(e){this.list_files=function(){e.get("http://www.dev.laclasse.com/docs-beta/api/connector?cmd=open&target=").success(function(e){console.debug(e)})}}]),angular.module("cahierDeTexteApp").service("User",["$http","APP_PATH",function(e,i){this.get_user=_.memoize(function(){return e.get(i+"/api/v0/users/current").success(function(e){return e.profil_actif=e.profils[0],e})})}]),angular.module("cahierDeTexteApp").factory("Classes",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/etablissements/:uai/classes/:id",{uai:"@uai",id:"@id"})}]),angular.module("cahierDeTexteApp").factory("Cours",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/cours/:id",{id:"@id"},{update:{method:"PUT"},valide:{method:"PUT",url:i+"/api/v0/cours/:id/valide"},copie:{method:"PUT",url:i+"/api/v0/cours/:id/copie/regroupement/:regroupement_id/creneau_emploi_du_temps/:creneau_emploi_du_temps_id",params:{id:"@id",regroupement_id:"@regroupement_id",creneau_emploi_du_temps_id:"@creneau_emploi_du_temps_id"}}})}]),angular.module("cahierDeTexteApp").factory("CreneauEmploiDuTemps",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/creneaux_emploi_du_temps/:id",{id:"@id",regroupement_id:"@regroupement_id",jour_de_la_semaine:"@jour_de_la_semaine",heure_debut:"@heure_debut",heure_fin:"@heure_fin",matiere_id:"@matiere_id"},{update:{method:"PUT"}})}]),angular.module("cahierDeTexteApp").factory("Devoirs",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/devoirs/:id",{id:"@id"},{update:{method:"PUT"},fait:{method:"PUT",url:i+"/api/v0/devoirs/:id/fait"}})}]),angular.module("cahierDeTexteApp").factory("EmploisDuTemps",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/emplois_du_temps/du/:debut/au/:fin",{debut:"@debut",fin:"@fin",uai:"@uai"})}]),angular.module("cahierDeTexteApp").factory("Enseignants",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/etablissements/:uai/enseignants/:enseignant_id",{uai:"@uai",enseignant_id:"@enseignant_id"})}]),angular.module("cahierDeTexteApp").factory("TypesDeDevoir",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/types_de_devoir/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").factory("PlagesHoraires",["$resource","APP_PATH",function(e,i){return e(i+"/api/v0/plages_horaires/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").service("API",["Classes","Cours","CreneauEmploiDuTemps","Devoirs","EmploisDuTemps","Enseignants","TypesDeDevoir","PlagesHoraires",function(e,i,t,a,n,r,s,u){this.query_classes=function(i){return e.query(i)},this.query_types_de_devoir=_.memoize(function(){return s.query()}),this.get_type_de_devoir=_.memoize(function(e){return s.get(e)}),this.query_emplois_du_temps=function(){return n.query()},this.get_creneau_emploi_du_temps=function(e){return t.get(e)},this.query_enseignants=function(e){return r.query(e)},this.get_enseignant=function(e){return r.get(e)},this.get_cours=function(e){return i.get(e)},this.query_devoirs=function(e){return a.query(e)},this.get_devoir=function(e){return a.get(e)},this.query_plages_horaires=function(){return u.query()},this.get_plage_horaire=function(e){return u.get(e)}}]),angular.module("cahierDeTexteApp").controller("EleveDevoirsCtrl",["$scope","API",function(e,i){e.empty=!1,e.affiche_faits=!1,e.fait=function(i){Devoirs.fait({id:i}).$promise.then(function(){_(e.devoirs).findWhere({id:i}).fait=!0})},e.filtre=function(){e.devoirs=e.affiche_faits?e.all_devoirs:_(e.all_devoirs).reject(function(e){return e.fait})},i.query_types_de_devoir().$promise.then(function(t){i.query_devoirs().$promise.then(function(i){e.all_devoirs=_(i).map(function(e){return e.type_devoir=_(t).findWhere({id:e.type_devoir_id}).label,e}),e.filtre(),e.empty=0==e.all_devoirs.length})})}]),angular.module("cahierDeTexteApp").controller("IndexCtrl",["Redirection",function(e){e.doorman([])}]),angular.module("cahierDeTexteApp").controller("HeaderCtrl",["$scope","User","Redirection",function(e,i,t){i.get_user().success(function(i){e.current_user=i}),e.reload=function(){t.doorman([])}}]),angular.module("cahierDeTexteApp").controller("EleveEmploiDuTempsCtrl",["$scope","$modal","CALENDAR_OPTIONS","CALENDAR_PARAMS","API","Annuaire","EmploisDuTemps","User",function(e,i,t,a,n,r,s,u){e.types_de_devoir={},e.calendar={options:t,events:[]},e.calendar.options.defaultView="agendaWeek",e.calendar.options.editable=!1,e.calendar.options.eventRender=function(e,i){i.find(".fc-event-title").append(e.description)},e.calendar.options.eventClick=function(i){e.creneau=_(i.source.events).findWhere({_id:i._id}),e.matiere=i.title,e.cours=e.creneau.details.cours,_(e.cours).size()>0&&(e.devoirs=e.creneau.details.devoirs,e.affiche_details())},e.calendar.options.viewRender=function(i){e.retrieve_data(i.visStart,i.visEnd)},e.cours={},e.devoirs=[],e.affiche_details=function(){i.open({templateUrl:"app/views/eleve/detail_emploi_du_temps.html",resolve:{matiere:function(){return e.matiere},cours:function(){return e.cours},devoirs:function(){return e.devoirs}},controller:["$scope","$modalInstance","Devoirs","matiere","cours","devoirs",function(e,i,t,a,n,r){e.matiere=a,e.cours=n,e.devoirs=r,e.fait=function(e){t.fait({id:e},function(){_(r).findWhere({id:e}).fait=!0})},e.fermer=function(){i.close(r)}}]}).result.then(function(i){_(i).each(function(i){_(e.calendar.events[0]).findWhere({type:"devoir",id:i.id}).className=i.fait?" saisie-devoirs-fait":" saisie-devoirs"}),e.emploi_du_temps.fullCalendar("renderEvent",e.creneau)})};var l=function(e){var i=function(e,i){var t=this;this.details={cours:e.cours,devoirs:e.devoirs},this.allDay=!1,this.title="",this.description="",this.color="",this.type=_(i).has("fait")?"devoir":"cours","cours"===this.type&&(i.start=e.start,i.end=e.end),this.start=new Date(i.start),this.end=new Date(i.end),"cours"===this.type?(this.className="saisie-invalide",e.matiere_id.length>0&&r.get_matiere(e.matiere_id).$promise.then(function(e){t.title=e.libelle_long})):(this.className=i.fait?"saisie-devoirs-fait":"saisie-devoirs",n.get_type_de_devoir({id:i.type_devoir_id}).$promise.then(function(e){t.title=e.label})),_(i).has("contenu")&&i.contenu.length>0?(this.description+='<br><span style="color:'+a.couleurs[this.type]+'">',this.description+=i.contenu.substring(0,a.max_length),this.description+=i.contenu.length>a.max_length?"…":"",this.description+="</span>",this.className+=" clickable-event",this.id=i.id):this.className="saisie-vide un-clickable-event"},t=[];return t.push(new i(e,e.cours)),_(e.devoirs).each(function(a){t.push(new i(e,a))}),t};e.retrieve_data=function(i,t){u.get_user().then(function(a){e.current_user=a.data,s.query({debut:i,fin:t,uai:e.current_user.profil_actif.uai},function(i){e.calendar.events[0]=_.chain(i).map(function(e){return l(e)}).flatten().value()})})}}]),angular.module("cahierDeTexteApp").controller("PrincipalEnseignantCtrl",["$scope","$stateParams","$q","$locale","THEME","API","Cours","Annuaire","User",function(e,i,t,a,n,r,s,u,l){e.enseignant_id=i.enseignant_id,e.classe=null,e.mois=a.DATETIME_FORMATS.MONTH,e.moisCourant=null,e.gridSaisies=[],e.selectedSaisies=[],e.matieres={},e.classes={},e.montre_valides=!1,e.filtre=function(i){var t=i;if(null!=e.moisCourant&&(t=_(t).where({mois:e.moisCourant+1})),null!=e.classe){var a=_(e.classes).invert()[e.classe];t=_(t).where({classe_id:a})}return t},e.grid={data:"gridSaisies",selectedItems:e.selectedSaisies,enableCellEdit:!1,plugins:[new ngGridFlexibleHeightPlugin],rowHeight:64,columnDefs:[{field:"classe",displayName:"Classe",cellTemplate:'<span data-ng-bind-html="row.entity.classe_id">{{classes[row.entity.classe_id]}}</span>'},{field:"matiere",displayName:"Matière",cellTemplate:'<span data-ng-bind-html="row.entity.matiere_id">{{matieres[row.entity.matiere_id]}}</span>'},{field:"cours",displayName:"Cours",cellTemplate:'<span style="overflow-y:auto" data-ng-bind-html="row.entity.cours.contenu"></span>'},{field:"devoir",displayName:"Travail à faire",cellTemplate:'<span style="overflow-y:auto" data-ng-bind-html="row.entity.devoir.contenu"></span>'},{field:"validated",displayName:"Validé",cellTemplate:'<div class="ngSelectionCell"><input tabindex="-1" class="ngSelectionCheckbox" type="checkbox" data-ng-model="row.entity.valide" data-ng-show="!row.entity.valide" data-ng-click="grid.valide( row )" /><input tabindex="-1" class="ngSelectionCheckbox" type="checkbox" disabled checked data-ng-show="row.entity.valide" /></div>'}],valide:function(i){i.entity.cours.$valide(),i.entity.valide=!0,e.raw_data[i.entity.index].valide=!0,e.graphiques.populate(e.gridSaisies)},valideSelection:function(){_(e.selectedSaisies).each(function(i){i.cours.$valide(),i.valide=!0,e.raw_data[i.index].valide=!0}),e.graphiques.populate(e.gridSaisies)},selectionneNonValides:function(){_(e.gridSaisies).each(function(i,t){i.valide===!1&&e.grid.selectItem(t,!0)})},populate:function(i){e.gridSaisies=e.filtre(i),e.montre_valides||(e.gridSaisies=_(e.gridSaisies).where({valide:!1}))}},e.xFunction=function(){return function(e){return e.label}},e.yFunction=function(){return function(e){return e.value}},e.descriptionFunction=e.xFunction,e.colorFunction=function(){var e=[n.validated.base,n.filled.base];return function(i,t){return e[t]}},e.barChartxAxisTickFormatFunction=function(){return function(e){return e}},e.graphiques={pieChart:{data:[{label:"valide",value:0},{label:"saisie",value:0}]},barChart:{data:[]},populate:function(i){e.graphiques.barChart.data=[],e.graphiques.pieChart.data[0].value=0,e.graphiques.pieChart.data[1].value=0;var t={key:"saisie",values:[]},a={key:"valide",values:[]};_.chain(e.filtre(i)).groupBy("classe_id").each(function(i){var n=i.length,r=_(i).where({valide:!0}).length;t.values.push([e.classes[i[0].classe_id],n]),a.values.push([e.classes[i[0].classe_id],r]),e.graphiques.barChart.data=[a,t],e.graphiques.pieChart.data[0].value+=r,e.graphiques.pieChart.data[1].value+=n-r})}},e.process_data=function(){void 0!==e.raw_data&&(e.raw_data=_(e.raw_data).map(function(e,i){return e.index=i,e.cours=new s(e.cours),e}),e.grid.populate(e.raw_data),e.graphiques.populate(e.raw_data))},e.extract_matieres=function(e){var i={};return _.chain(e).flatten().pluck("matiere_id").uniq().each(function(e){u.get_matiere(e).$promise.then(function(t){i[e]=t.libelle_long})}),i},e.extract_classes_promises=function(e){return _.chain(e).flatten().pluck("classe_id").uniq().map(function(e){return u.get_regroupement(e)}).value()},u.get_user(e.enseignant_id).$promise.then(function(i){e.enseignant=i,e.enseignant.matieres=_(e.enseignant.classes).uniq(function(e){return e.matiere_enseignee_id}),e.enseignant.prof_principal=_.chain(e.enseignant.classes).filter(function(e){return"O"==e.prof_principal}).map(function(e){return e.classe_libelle}).value()}),l.get_user().then(function(a){var n=a.data;r.get_enseignant({enseignant_id:i.enseignant_id,uai:n.profil_actif.uai}).$promise.then(function(i){e.raw_data=i.saisies,e.matieres=e.extract_matieres(e.raw_data),t.all(e.extract_classes_promises(e.raw_data)).then(function(i){_(i).each(function(i){e.classes[i.id]=null!==i.libelle?i.libelle:i.libelle_aaf}),e.process_data()})})})}]),angular.module("cahierDeTexteApp").controller("PrincipalClassesCtrl",["$scope","THEME","$locale","$q","API","Annuaire","User",function(e,i,t,a,n,r,s){e.empty=!1,s.get_user().then(function(s){var u=s.data;e.raw_data=[],e.displayed_data=[],e.classes={},e.matieres=[],e.annee=t.DATETIME_FORMATS.MONTH,e.classe=null,e.moisCourant=null,e.matiereCourante=null,e.global_stats={filled:0,validated:0},e.xFunction=function(){return function(e){return e.label}},e.yFunction=function(){return function(e){return e.value}},e.descriptionFunction=e.xFunction,e.colorFunction=function(){var e=[i.validated.base,i.filled.base];return function(i,t){return e[t]}},e.xAxisTickFormatFunction=function(){return function(e){return e}},e.pieChart={data:[{label:"saisie",value:0},{label:"valide",value:0}],populate:function(i){e.pieChart.data[0].value=i.filled-i.validated,e.pieChart.data[1].value=i.validated}},e.monthlyLineChart={data:[],populate:function(t){var a=[];_(12).times(function(i){a.push([e.annee[i],i])});var n=t.reduce(function(e,i){return _(i.mensuel.filled.length).times(function(t){e.filled[t].y+=i.mensuel.filled[t],e.validated[t].y+=i.mensuel.validated[t]}),e},{filled:a,validated:a});e.monthlyLineChart.data[0]={key:"saisie",area:!0,color:i.filled.base,values:n.filled},e.monthlyLineChart.data[1]={key:"valide",area:!1,color:i.validated.base,values:n.validated}}},e.individualCharts={classes:[],populate:function(i,t){e.individualCharts.classes=_.chain(i).map(function(e){return{libelle:t[e.regroupement_id],pieChart:{data:[{label:"valide",value:e.validated},{label:"saisie",value:e.filled-e.validated}]}}}).value()}},e.extract_matieres=function(e){return _.chain(e).pluck("matieres").flatten().pluck("matiere_id").uniq().map(function(e){var i={id:e,libelle:"Matière inconnue !"};return r.get_matiere(e).$promise.then(function(e){i.libelle=e.libelle_long}),i}).value()},e.extract_classes=function(e){return _.chain(e).pluck("regroupement_id").map(function(e){return r.get_regroupement(e)}).value()},e.process_data=function(){if(e.raw_data.length>0){e.displayed_data=e.raw_data,null!=e.classe&&(e.filtered_data=_(e.raw_data).filter(function(i){return i.regroupement_id==e.classe})),null!=e.matiereCourante&&(e.displayed_data=e.displayed_data.map(function(i){var t=_(i.matieres).filter(function(i){return i.matiere_id==e.matiereCourante});return{regroupement_id:i.regroupement_id,matieres:t}})),null!=e.moisCourant&&(e.displayed_data=e.displayed_data.map(function(i){return{regroupement_id:i.regroupement_id,matieres:i.matieres.map(function(i){return{matiere_id:i.matiere_id,mois:_(i.mois).filter(function(i){return i.mois==e.moisCourant})}})}})),_(e.displayed_data).each(function(e){e.mensuel=e.matieres.reduce(function(e,i){return _(i.mois).each(function(i){e.filled[i.mois-1]+=i.filled,e.validated[i.mois-1]+=i.validated}),e},{filled:[0,0,0,0,0,0,0,0,0,0,0,0],validated:[0,0,0,0,0,0,0,0,0,0,0,0]}),e.filled=e.mensuel.filled.reduce(function(e,i){return e+i},0),e.validated=e.mensuel.validated.reduce(function(e,i){return e+i},0)});var i=e.displayed_data.reduce(function(e,i){return{filled:e.filled+i.filled,validated:e.validated+i.validated}},{filled:0,validated:0});e.displayed_data.filled=i.filled,e.displayed_data.validated=i.validated,e.individualCharts.populate(e.displayed_data,e.classes),e.pieChart.populate(e.displayed_data),e.monthlyLineChart.populate(e.displayed_data)}},n.query_classes({uai:u.profil_actif.uai}).$promise.then(function(i){e.raw_data=i,e.empty=0==_(e.raw_data[0]).size(),e.empty||(e.matieres=e.extract_matieres(e.raw_data),e.classes=e.extract_classes(e.raw_data),a.all(e.matieres,e.classes).then(function(){_(e.classes).each(function(e){console.debug(e.libelle_aaf),null===e.libelle&&(e.libelle=e.libelle_aaf)}),e.process_data()}))})})}]),angular.module("cahierDeTexteApp").controller("EnseignantCtrl",["$scope","$modal","$q","$filter","CALENDAR_OPTIONS","CALENDAR_PARAMS","TINYMCE_OPTIONS","API","Annuaire","Documents","Cours","Devoirs","EmploisDuTemps","CreneauEmploiDuTemps","User",function(e,i,t,a,n,r,s,u,l,d,o,c,p,f,m){e.types_de_devoir=u.query_types_de_devoir(),e.matieres=[],e.classes=[],e.classe=null,console.debug(d.list_files),e.calendar={options:n,events:[]},e.calendar.options.defaultView="agendaWeek",e.calendar.options.eventRender=function(e,i){i.find(".fc-event-title").append(" - "+e.regroupement+"<br>"+e.description)},e.calendar.options.viewRender=function(i){e.retrieve_data(i.visStart,i.visEnd)},e.calendar.options.eventClick=function(i){var a=function(e){var i=new o({cahier_de_textes_id:e.details.cahier_de_textes_id,creneau_emploi_du_temps_id:e.details.creneau_emploi_du_temps_id,date_cours:new Date(e.start).toISOString()});return i.create=!0,i};e.creneau=_(i.source.events).findWhere({_id:i._id}),e.cours=null,e.devoirs=null,e.regroupement_id=null,e.matiere_id=null,e.matiere_id=i.details.matiere_id,e.regroupement_id=i.details.regroupement_id,e.cours=void 0!==e.creneau.details.cours.id?u.get_cours({id:e.creneau.details.cours.id}):a(e.creneau),t.all(e.cours,e.types_de_devoir,e.matieres,e.classes).then(function(){e.devoirs=[],e.creneau.details.devoirs.length>0&&(_(e.creneau.details.devoirs).each(function(){u.get_devoir({id:e.creneau.details.devoirs[0].id}).$promise.then(function(i){e.devoirs.push(i)})}),e.devoirs.create=!1),t.all(e.devoirs).then(function(){e.ouvre_popup_edition()})})},e.ouvre_popup_edition=function(){i.open({templateUrl:"app/views/enseignant/detail_emploi_du_temps.html",resolve:{raw_data:function(){return e.raw_data},matieres:function(){return e.matieres},classes:function(){return e.classes},matiere_id:function(){return e.matiere_id},regroupement_id:function(){return e.regroupement_id},cours:function(){return e.cours},devoirs:function(){return e.devoirs},types_de_devoir:function(){return e.types_de_devoir}},controller:["$scope","$filter","TINYMCE_OPTIONS","$modalInstance","cours","devoirs","types_de_devoir","matiere_id","regroupement_id","raw_data","classes","matieres",function(e,i,a,n,r,s,u,l,d,o,p,f){e.matieres_ary=_(e.matieres).values(),e.dirty=!1,e.deleted=!1,e.is_dirty=function(){e.dirty=!0};var m=function(e){var i=new Date,t=new c({cours_id:e.id,date_due:i.toISOString(),type_devoir_id:null});return t.create=!0,t};e.openDatePicker=function(i){i.preventDefault(),i.stopPropagation(),e.opened=!0},e.ajout_devoir=function(){e.devoirs.unshift(m(e.cours))},e.dupliquer=function(){_(e.creneaux_similaires.selected).each(function(i){e.cours.$copie({regroupement_id:i.regroupement_id,creneau_emploi_du_temps_id:i.creneau_emploi_du_temps_id})})},e.fermer=function(){n.close({dirty:e.dirty,deleted:e.deleted,cours:e.cours,devoirs:e.devoirs,matiere_id:e.matiere_id,regroupement_id:e.regroupement_id})},e.effacer=function(){e.cours.$delete(),_(e.devoirs).each(function(e){e.$delete()}),e.deleted=!1,e.fermer()},e.annuler=function(){e.dirty=!1,e.fermer()},e.valider=function(){if(e.erreurs=[],""!==e.matiere_id&&""!==e.regroupement_id){var i=t.when(!0);_(e.cours).has("contenu")&&e.cours.contenu.length>0&&(e.cours.dirty=!0,i=e.cours.create?e.cours.$save():e.cours.$update()),i.then(function(i){e.cours=i;var a=[];e.devoirs=_(e.devoirs).map(function(i){if(_(i).has("contenu")&&i.contenu.length>0){i.dirty=!0;var n=t.defer();i.create?(i.cours_id=e.cours.id,i.$save().then(function(e){i.id=e.id,n.resolve(e)},function(i){e.erreurs.unshift({status:i.status,message:i.data.error}),n.reject(i)})):i.$update().then(function(e){i.id=e.id,n.resolve(e)},function(i){e.erreurs.unshift({status:i.status,message:i.data.error}),n.reject(i)}),a.push(n.promise)}return i}),t.all(a).then(function(){e.fermer()})})}else e.erreurs.push({message:"Aucune matière ou classe défini"})},e.tinyMCEOptions=a,e.cours=r,e.devoirs=s,e.types_de_devoir=u,e.matieres=f,e.classes=p,e.matiere_id=l.length>0?l:_.chain(e.matieres).values().first().value().id,e.regroupement_id=d.length>0?d:e.classes[0].id,e.classe=_(e.classes).findWhere({id:parseInt(e.regroupement_id)}),e.matiere=e.matieres[e.matiere_id],e.erreurs=[],e.dateOptions={"year-format":"'yy'","starting-day":1},e.datePickerOpened=!1,e.scope=e,e.creneaux_similaires=_.chain(o).filter(function(i){return i.regroupement_id!=e.regroupement_id&&i.matiere_id==e.matiere_id}).map(function(t){return t.classe=_(e.classes).findWhere({id:parseInt(t.regroupement_id)}),t.start_str=i("date")(t.start,"short"),t.end_str=i("date")(t.end,"shortTime"),t}).value(),e.creneaux_similaires.selected=[],e.creneaux_devoirs_possibles=_.chain(o).filter(function(i){return i.regroupement_id==e.regroupement_id&&i.matiere_id==e.matiere_id}).map(function(t){return t.classe=_(e.classes).findWhere({id:parseInt(t.regroupement_id)}),t.start_str=i("date")(t.start,"short"),t.end_str=i("date")(t.end,"shortTime"),t}).value()}]}).result.then(function(i){var t={};if(i.devoirs=_(i.devoirs).filter(function(e){return _(e).has("id")}),_(e.creneau).has("_id")){t=e.update_fullCalendar_event(e.creneau,i.cours,i.devoirs);var a=_(e.calendar.events[0]).indexOf(e.creneau);_.chain(t).keys().reject(function(e){return"title"==e}).each(function(i){e.calendar.events[0][a][i]=t[i]}),e.emploi_du_temps.fullCalendar("renderEvent",e.calendar.events[0][a])}else if(i.dirty){e.creneau.matiere_id=i.matiere_id,e.creneau.regroupement_id=i.regroupement_id,e.creneau.$update();var n={cours:i.cours,devoirs:i.devoirs,cahier_de_textes_id:i.cours.cahier_de_textes_id,creneau_emploi_du_temps_id:i.cours.creneau_emploi_du_temps_id,matiere_id:i.matiere_id,regroupement_id:i.regroupement_id,start:e.creneau.heure_debut,end:e.creneau.heure_fin};t=e.assemble_fullCalendar_event(n),e.calendar.events[0].push(t),e.emploi_du_temps.fullCalendar("renderEvent",_(e.calendar.events[0]).last(),!0)}else e.creneau.$delete()})},e.update_fullCalendar_event=function(i,t,a){var n=function(e,i){if(e.length>i){var t=e.substring(0,i);return t=t.substring(0,t.lastIndexOf(" ")),t+="…"}return e};if(t.deleted)return console.debug("Cours détruit"),s={details:{matiere_id:i.details.matiere_id,regroupement_id:i.details.regroupement_id,cahier_de_textes_id:i.details.cahier_de_textes_id,creneau_emploi_du_temps_id:i.details.creneau_emploi_du_temps_id,cours:{},devoirs:[]},allDay:!1,title:"",description:"",regroupement:"",start:i.start,end:i.end,className:"clickable-event"};console.debug("Cours NON  détruit");var s={details:{matiere_id:i.details.matiere_id,regroupement_id:i.details.regroupement_id,cahier_de_textes_id:i.details.cahier_de_textes_id,creneau_emploi_du_temps_id:i.details.creneau_emploi_du_temps_id,cours:t,devoirs:a},allDay:!1,title:"",description:"",regroupement:"",start:i.start,end:i.end,className:"clickable-event"};return s.className+=void 0===t.contenu||0==t.contenu.length?" saisie-vide":a.length>0?" saisie-devoirs":null!=t.date_validation?" saisie-valide":" saisie-invalide",_(t).size()>0&&(s.description+='<br><span style="color:'+r.couleurs.cours+'">',s.description+=n(t.contenu,r.cours_max_length),s.description+="</span>"),s.regroupement=i.details.regroupement_id.length>0?_.chain(e.classes).filter(function(e){return e.id==i.details.regroupement_id}).pluck("libelle_aaf").value()[0]:"",i.details.matiere_id.length>0&&(console.debug(i.details.matiere_id),s.title=e.matieres[i.details.matiere_id].libelle_long),s},e.assemble_fullCalendar_event=function(i){return e.update_fullCalendar_event({details:{matiere_id:i.matiere_id,regroupement_id:i.regroupement_id,cahier_de_textes_id:i.cahier_de_textes_id,creneau_emploi_du_temps_id:i.creneau_emploi_du_temps_id},start:i.start,end:i.end},i.cours,i.devoirs)},e.list_classes=function(e){return _.chain(e.classes).reject(function(i){return i.etablissement_code!==e.profil_actif.uai}).pluck("regroupement_id").uniq().map(function(e){return l.get_regroupement(e)}).value()},e.list_matieres=function(e){return _.chain(e.classes).reject(function(i){return i.etablissement_code!==e.profil_actif.uai||void 0===i.matiere_enseignee_id}).pluck("matiere_enseignee_id").uniq().map(function(e){return l.get_matiere(e)}).value()},e.process_data=function(){var i=e.raw_data;null!=e.classe&&(i=_(e.raw_data).filter(function(i){return i.regroupement_id==e.classe})),e.calendar.events[0]=_(i).map(function(i){return e.assemble_fullCalendar_event(i)})},e.retrieve_data=function(i,a){m.get_user().then(function(n){e.current_user=n.data,p.query({debut:i,fin:a,uai:e.current_user.profil_actif.uai},function(i){e.raw_data=i,e.matieres=e.list_matieres(e.current_user),e.classes=e.list_classes(e.current_user),t.all(e.matieres,e.classes).then(function(){e.matieres=_.chain(e.matieres).map(function(e){return[e.id,e]}).object().value(),_(e.classes).each(function(e){e.libelle=null===e.libelle&&null!==e.libelle_aaf?e.libelle_aaf:e.libelle,e.libelle_aaf=null===e.libelle_aaf&&null!==e.libelle?e.libelle:e.libelle_aaf}),e.calendar.options.editable=e.classes.length>0&&_(e.matieres).size()>0,e.calendar.options.editable&&(e.calendar.options.disableDragging=!0,e.calendar.options.eventDurationEditable=!1,e.calendar.options.selectable=!0,e.calendar.options.selectHelper=!0,e.calendar.options.select=function(i,a){var n=6e4*new Date(i).getTimezoneOffset();e.creneau=new f({regroupement_id:"",jour_de_la_semaine:i.getDay()+1,heure_debut:new Date(new Date(i)-n).toISOString(),heure_fin:new Date(new Date(a)-n).toISOString(),matiere_id:""}),e.creneau.$save().then(function(){e.creneau.dirty=!0,e.creneau.heure_debut=i,e.creneau.heure_fin=a;var n=function(){var t=new o({cahier_de_textes_id:"",creneau_emploi_du_temps_id:e.creneau.id,date_cours:new Date(i).toISOString()});return t.create=!0,t};e.creneau.regroupement_id="",e.cours=null,e.devoirs=null,e.regroupement_id=null,e.matiere_id=null,e.matiere_id=e.creneau.matiere_id,e.regroupement_id=e.creneau.regroupement_id,e.cours=n(e.creneau),e.devoirs=[],t.all(e.types_de_devoir,e.cours).then(function(){e.creneau.details={cours:e.cours,devoirs:e.devoirs},e.ouvre_popup_edition()}),e.emploi_du_temps.fullCalendar("unselect")})}),e.process_data()})})})}}]),angular.module("cahierDeTexteApp").controller("PrincipalEnseignantsCtrl",["$scope","$locale","THEME","$q","API","Annuaire","User",function(e,i,t,a,n,r,s){e.annee=i.DATETIME_FORMATS.MONTH,e.classe=null,e.mois=null,e.classes={},e.details_enseignants={},e.xFunction=function(){return function(e){return e.label}},e.yFunction=function(){return function(e){return e.value}},e.descriptionFunction=e.xFunction,e.colorFunction=function(){var e=[t.validated.base,t.filled.base];return function(i,t){return e[t]}},e.barChartxAxisTickFormatFunction=function(){return function(e){return e}},e.pieChart={data:[{label:"valide",value:0},{label:"saisie",value:0}],populate:function(i){e.pieChart.data[0].value=i.validated,e.pieChart.data[1].value=i.filled-i.validated}},e.barChart={data:[],populate:function(i){var t={key:"saisie",values:[]},a={key:"valide",values:[]};_(i).each(function(i){t.values.push([e.details_enseignants[i.enseignant_id].full_name,i.filled]),a.values.push([e.details_enseignants[i.enseignant_id].full_name,i.validated])}),e.barChart.data=[a,t]}},e.individualCharts={enseignants:[],populate:function(i,t){e.individualCharts.enseignants=_.chain(i).map(function(e){return{enseignant:t[e.enseignant_id],pieChart:{data:[{label:"valide",value:e.validated},{label:"saisie",value:e.filled-e.validated}]}}}).value()}},e.extract_classes_promises=function(e){return _.chain(e).pluck("classes").flatten().pluck("regroupement").uniq().reject(function(e){return""===e}).map(function(e){return r.get_regroupement(e).$promise}).value()},e.extract_details_enseignants_promises=function(e){return _(e).pluck("enseignant_id").map(function(e){return r.get_user(e).$promise})},e.process_data=function(){if(void 0!==e.raw_data){if(e.displayed_data=e.raw_data,null!=e.classe){var i=_(e.classes).invert()[e.classe];e.displayed_data=_.chain(e.displayed_data).map(function(e){return{enseignant_id:e.enseignant_id,classes:_(e.classes).reject(function(e){return e.regroupement!=i})}}).reject(function(e){return 0===e.classes.length}).value()}null!=e.mois&&(e.displayed_data=_(e.displayed_data).map(function(i){return{enseignant_id:i.enseignant_id,classes:_(i.classes).map(function(i){return{regroupement:i.regroupement,statistiques:_(i.statistiques).reject(function(i){return i.month!=e.mois})}})}})),e.displayed_data.filled=0,e.displayed_data.validated=0,_(e.displayed_data).each(function(i){var t=_(i.classes).reduce(function(e,i){var t=_(i.statistiques).reduce(function(e,i){return{filled:e.filled+i.filled,validated:e.validated+i.validated}},{filled:0,validated:0});return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});i.filled=t.filled,i.validated=t.validated,e.displayed_data.filled+=t.filled,e.displayed_data.validated+=t.validated}),e.pieChart.populate(e.displayed_data),e.individualCharts.populate(e.displayed_data,e.details_enseignants),e.barChart.populate(e.displayed_data)}},s.get_user().then(function(i){var t=i.data;n.query_enseignants({uai:t.profil_actif.uai}).$promise.then(function(i){e.raw_data=_(i).reject(function(e){return""===e.enseignant_id}),a.all(e.extract_details_enseignants_promises(e.raw_data)).then(function(i){_(i).each(function(i){i.matieres=_.chain(i.classes).pluck("matiere_libelle").uniq().value(),e.details_enseignants[i.id_ent]=i}),a.all(e.extract_classes_promises(e.raw_data)).then(function(i){_(i).each(function(i){e.classes[i.id]=null!==i.libelle?i.libelle:i.libelle_aaf}),e.process_data()})})})})}]);