"use strict";angular.module("cahierDeTexteApp").service("User",["$http","APP_PATH","API_VERSION",function(e,t,r){this.get_user=_.memoize(function(){return e.get(t+"/api/"+r+"/users/current").success(function(e){return _(e.profils).each(function(t){t.classes=_.chain(e.classes).filter(function(e){return e.etablissement_code==t.uai}).map(function(e){return{id:e.classe_id,libelle:e.classe_libelle,type:e.type}}).uniq(function(e){return e.id}).reject(function(e){return _.isUndefined(e.id)}).value(),t.matieres=_.chain(e.classes).filter(function(e){return e.etablissement_code==t.uai}).map(function(e){return{id:_(e.matiere_enseignee_id).isNull()?e.matiere_libelle:e.matiere_enseignee_id,libelle_long:e.matiere_libelle}}).uniq(function(e){return e.id}).reject(function(e){return _.isUndefined(e.id)}).value()}),e.profil_actif=_(e.profils).findWhere({actif:!0}),e.enfants.length>0&&(e.enfant_actif=e.enfants[0]),e.is=function(e){return this.profil_actif.type==e},e})}),this.update_parameters=function(n){return e.put(t+"/api/"+r+"/users/current/parametres",{parametres:JSON.stringify(n)})}}]),angular.module("cahierDeTexteApp").factory("Classes",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/etablissements/:uai/statistiques/classes/:id",{uai:"@uai",id:"@id"})}]),angular.module("cahierDeTexteApp").factory("Cours",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/cours/:id",{id:"@id"},{update:{method:"PUT"},valide:{method:"PUT",url:t+"/api/"+r+"/cours/:id/valide"},copie:{method:"PUT",url:t+"/api/"+r+"/cours/:id/copie/regroupement/:regroupement_id/creneau_emploi_du_temps/:creneau_emploi_du_temps_id/date/:date",params:{id:"@id",regroupement_id:"@regroupement_id",creneau_emploi_du_temps_id:"@creneau_emploi_du_temps_id",date:"@date"}}})}]),angular.module("cahierDeTexteApp").factory("CreneauEmploiDuTemps",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/creneaux_emploi_du_temps/:id",{id:"@id",regroupement_id:"@regroupement_id",previous_regroupement_id:"@previous_regroupement_id",jour_de_la_semaine:"@jour_de_la_semaine",heure_debut:"@heure_debut",heure_fin:"@heure_fin",matiere_id:"@matiere_id",semaines_de_presence_regroupement:"@semaines_de_presence_regroupement",semaines_de_presence_enseignant:"@semaines_de_presence_enseignant",semaines_de_presence_salle:"@semaines_de_presence_salle"},{update:{method:"PUT"},"delete":{method:"DELETE",params:{id:"@id",date_creneau:"@date_creneau"}}})}]),angular.module("cahierDeTexteApp").factory("Devoirs",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/devoirs/:id",{id:"@id",uid:"@uid"},{update:{method:"PUT"},fait:{method:"PUT",url:t+"/api/"+r+"/devoirs/:id/fait"},copie:{method:"PUT",url:t+"/api/"+r+"/devoirs/:id/copie/cours/:cours_id/creneau_emploi_du_temps/:creneau_emploi_du_temps_id/date_due/:date_due",params:{id:"@id",cours_id:"@cours_id",creneau_emploi_du_temps_id:"@creneau_emploi_du_temps_id",date_due:"@date_due"}}})}]),angular.module("cahierDeTexteApp").factory("EmploisDuTemps",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/emplois_du_temps/du/:debut/au/:fin",{debut:"@debut",fin:"@fin",uai:"@uai",uid:"@uid"})}]),angular.module("cahierDeTexteApp").factory("Enseignants",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/etablissements/:uai/statistiques/enseignants/:enseignant_id",{uai:"@uai",enseignant_id:"@enseignant_id"})}]),angular.module("cahierDeTexteApp").factory("TypesDeDevoir",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/types_de_devoir/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").factory("PlagesHoraires",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/plages_horaires/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").factory("CahierDeTextes",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/cahiers_de_textes/regroupement/:regroupement_id",{regroupement_id:"@regroupement_id"})}]),angular.module("cahierDeTexteApp").service("API",["$http","APP_PATH","API_VERSION","Classes","Cours","CreneauEmploiDuTemps","Devoirs","EmploisDuTemps","Enseignants","TypesDeDevoir","PlagesHoraires","CahierDeTextes",function(e,t,r,n,i,a,s,u,o,c,d,l){this.query_classes=function(e){return n.query(e)},this.query_types_de_devoir=_.memoize(function(){return c.query()}),this.get_type_de_devoir=_.memoize(function(e){return c.get(e)}),this.query_emplois_du_temps=function(){return u.query()},this.get_creneau_emploi_du_temps=function(e){return a.get(e)},this.get_creneaux_emploi_du_temps_similaires=function(n){return e.get(t+"/api/"+r+"/creneaux_emploi_du_temps/"+n.id+"/similaires?debut="+n.debut.toISOString()+"&fin="+n.fin.toISOString())},this.query_enseignants=function(e){return o.query(e)},this.get_enseignant=function(e){return o.get(e)},this.get_cours=function(e){return i.get(e)},this.query_devoirs=function(e){return s.query(e)},this.get_devoir=function(e){return s.get(e)},this.query_plages_horaires=function(){return d.query()},this.get_plage_horaire=function(e){return d.get(e)},this.get_cahier_de_textes=_.memoize(function(e){return l.get(e)})}]),angular.module("cahierDeTexteApp").factory("Matieres",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/annuaire/matieres/:matiere_id",{matiere_id:"@matiere_id"})}]),angular.module("cahierDeTexteApp").factory("Regroupements",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/annuaire/regroupements/:regroupement_id",{regroupement_id:"@regroupement_id"})}]),angular.module("cahierDeTexteApp").factory("Users",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/annuaire/users/:user_id",{user_id:"@user_id"})}]),angular.module("cahierDeTexteApp").service("Annuaire",["$http","Matieres","Regroupements","Users","APP_PATH","API_VERSION",function(e,t,r,n,i,a){this.get_matieres=_.memoize(function(){return e.get(i+"/api/"+a+"/annuaire/matieres")}),this.get_etablissement_enseignants=_.memoize(function(t){return e.get(i+"/api/"+a+"/annuaire/etablissements/"+t+"/enseignants")}),this.get_etablissement_regroupements=_.memoize(function(t){return e.get(i+"/api/"+a+"/annuaire/etablissements/"+t+"/regroupements")}),this.get_matiere=_.memoize(function(e){return t.get({matiere_id:e})}),this.get_regroupement=_.memoize(function(e){return r.get({regroupement_id:e})}),this.get_user=_.memoize(function(e){return n.get({user_id:e})})}]),angular.module("cahierDeTexteApp").service("Documents",["$http","DOCS_URL",function(e,t){this.list_files=function(r){return r="undefined"==typeof r?"&init=1":r,e.get(t+"/api/connector?cmd=open&target="+r)},this.ajout_au_cahier_de_textes=function(r,n){return e.get(t+"/api/ctxt/copy/regroupement/"+r.type+"/share/"+r.id+"?cmd=paste&targets[]="+n+"&cut=0&attachment=CAHIERTXT")},this.upload_dans_cahier_de_textes=function(r,n){for(var i=[],a=0;a<n.length;a++){var s=new FormData;s.append("upload[]",n.item(a)),s.append("id","upload"),s.append("cmd","upload"),s.append("current",0),s.append("attachment","CAHIERTXT"),s.append("share",r.id),s.append("regroupement",r.type),i.push(e.post(t+"/api/ctxt/add/regroupement/"+r.type+"/share/"+r.id,s,{headers:{"Content-Type":void 0},transformRequest:angular.identity}))}return i}}]),angular.module("cahierDeTexteApp").factory("Matieres",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/annuaire/matieres/:matiere_id",{matiere_id:"@matiere_id"})}]),angular.module("cahierDeTexteApp").factory("Regroupements",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/annuaire/regroupements/:regroupement_id",{regroupement_id:"@regroupement_id"})}]),angular.module("cahierDeTexteApp").factory("Users",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/annuaire/users/:user_id",{user_id:"@user_id"})}]),angular.module("cahierDeTexteApp").service("Annuaire",["$http","Matieres","Regroupements","Users","APP_PATH","API_VERSION",function(e,t,r,n,i,a){this.get_matieres=_.memoize(function(){return e.get(i+"/api/"+a+"/annuaire/matieres")}),this.get_etablissement_enseignants=_.memoize(function(t){return e.get(i+"/api/"+a+"/annuaire/etablissements/"+t+"/enseignants")}),this.get_etablissement_regroupements=_.memoize(function(t){return e.get(i+"/api/"+a+"/annuaire/etablissements/"+t+"/regroupements")}),this.get_matiere=_.memoize(function(e){return t.get({matiere_id:e})}),this.get_regroupement=_.memoize(function(e){return r.get({regroupement_id:e})}),this.get_user=_.memoize(function(e){return n.get({user_id:e})})}]),angular.module("cahierDeTexteApp").service("User",["$http","APP_PATH","API_VERSION",function(e,t,r){this.get_user=_.memoize(function(){return e.get(t+"/api/"+r+"/users/current").success(function(e){return _(e.profils).each(function(t){t.classes=_.chain(e.classes).filter(function(e){return e.etablissement_code==t.uai}).map(function(e){return{id:e.classe_id,libelle:e.classe_libelle,type:e.type}}).uniq(function(e){return e.id}).reject(function(e){return _.isUndefined(e.id)}).value(),t.matieres=_.chain(e.classes).filter(function(e){return e.etablissement_code==t.uai}).map(function(e){return{id:_(e.matiere_enseignee_id).isNull()?e.matiere_libelle:e.matiere_enseignee_id,libelle_long:e.matiere_libelle}}).uniq(function(e){return e.id}).reject(function(e){return _.isUndefined(e.id)}).value()}),e.profil_actif=_(e.profils).findWhere({actif:!0}),e.enfants.length>0&&(e.enfant_actif=e.enfants[0]),e.is=function(e){return this.profil_actif.type==e},e})}),this.update_parameters=function(n){return e.put(t+"/api/"+r+"/users/current/parametres",{parametres:JSON.stringify(n)})}}]),angular.module("cahierDeTexteApp").factory("Classes",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/etablissements/:uai/statistiques/classes/:id",{uai:"@uai",id:"@id"})}]),angular.module("cahierDeTexteApp").factory("Cours",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/cours/:id",{id:"@id"},{update:{method:"PUT"},valide:{method:"PUT",url:t+"/api/"+r+"/cours/:id/valide"},copie:{method:"PUT",url:t+"/api/"+r+"/cours/:id/copie/regroupement/:regroupement_id/creneau_emploi_du_temps/:creneau_emploi_du_temps_id/date/:date",params:{id:"@id",regroupement_id:"@regroupement_id",creneau_emploi_du_temps_id:"@creneau_emploi_du_temps_id",date:"@date"}}})}]),angular.module("cahierDeTexteApp").factory("CreneauEmploiDuTemps",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/creneaux_emploi_du_temps/:id",{id:"@id",regroupement_id:"@regroupement_id",previous_regroupement_id:"@previous_regroupement_id",jour_de_la_semaine:"@jour_de_la_semaine",heure_debut:"@heure_debut",heure_fin:"@heure_fin",matiere_id:"@matiere_id",semaines_de_presence_regroupement:"@semaines_de_presence_regroupement",semaines_de_presence_enseignant:"@semaines_de_presence_enseignant",semaines_de_presence_salle:"@semaines_de_presence_salle"},{update:{method:"PUT"},"delete":{method:"DELETE",params:{id:"@id",date_creneau:"@date_creneau"}}})}]),angular.module("cahierDeTexteApp").factory("Devoirs",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/devoirs/:id",{id:"@id",uid:"@uid"},{update:{method:"PUT"},fait:{method:"PUT",url:t+"/api/"+r+"/devoirs/:id/fait"},copie:{method:"PUT",url:t+"/api/"+r+"/devoirs/:id/copie/cours/:cours_id/creneau_emploi_du_temps/:creneau_emploi_du_temps_id/date_due/:date_due",params:{id:"@id",cours_id:"@cours_id",creneau_emploi_du_temps_id:"@creneau_emploi_du_temps_id",date_due:"@date_due"}}})}]),angular.module("cahierDeTexteApp").factory("EmploisDuTemps",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/emplois_du_temps/du/:debut/au/:fin",{debut:"@debut",fin:"@fin",uai:"@uai",uid:"@uid"})}]),angular.module("cahierDeTexteApp").factory("Enseignants",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/etablissements/:uai/statistiques/enseignants/:enseignant_id",{uai:"@uai",enseignant_id:"@enseignant_id"})}]),angular.module("cahierDeTexteApp").factory("TypesDeDevoir",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/types_de_devoir/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").factory("PlagesHoraires",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/plages_horaires/:id",{id:"@id"})}]),angular.module("cahierDeTexteApp").factory("CahierDeTextes",["$resource","APP_PATH","API_VERSION",function(e,t,r){return e(t+"/api/"+r+"/cahiers_de_textes/regroupement/:regroupement_id",{regroupement_id:"@regroupement_id"})}]),angular.module("cahierDeTexteApp").service("API",["$http","APP_PATH","API_VERSION","Classes","Cours","CreneauEmploiDuTemps","Devoirs","EmploisDuTemps","Enseignants","TypesDeDevoir","PlagesHoraires","CahierDeTextes",function(e,t,r,n,i,a,s,u,o,c,d,l){this.query_classes=function(e){return n.query(e)},this.query_types_de_devoir=_.memoize(function(){return c.query()}),this.get_type_de_devoir=_.memoize(function(e){return c.get(e)}),this.query_emplois_du_temps=function(){return u.query()},this.get_creneau_emploi_du_temps=function(e){return a.get(e)},this.get_creneaux_emploi_du_temps_similaires=function(n){return e.get(t+"/api/"+r+"/creneaux_emploi_du_temps/"+n.id+"/similaires?debut="+n.debut.toISOString()+"&fin="+n.fin.toISOString())},this.query_enseignants=function(e){return o.query(e)},this.get_enseignant=function(e){return o.get(e)},this.get_cours=function(e){return i.get(e)},this.query_devoirs=function(e){return s.query(e)},this.get_devoir=function(e){return s.get(e)},this.query_plages_horaires=function(){return d.query()},this.get_plage_horaire=function(e){return d.get(e)},this.get_cahier_de_textes=_.memoize(function(e){return l.get(e)})}]),angular.module("cahierDeTexteApp").service("Documents",["$http","DOCS_URL",function(e,t){this.list_files=function(r){return r="undefined"==typeof r?"&init=1":r,e.get(t+"/api/connector?cmd=open&target="+r)},this.ajout_au_cahier_de_textes=function(r,n){return e.get(t+"/api/ctxt/copy/regroupement/"+r.type+"/share/"+r.id+"?cmd=paste&targets[]="+n+"&cut=0&attachment=CAHIERTXT")},this.upload_dans_cahier_de_textes=function(r,n){for(var i=[],a=0;a<n.length;a++){var s=new FormData;s.append("upload[]",n.item(a)),s.append("id","upload"),s.append("cmd","upload"),s.append("current",0),s.append("attachment","CAHIERTXT"),s.append("share",r.id),s.append("regroupement",r.type),i.push(e.post(t+"/api/ctxt/add/regroupement/"+r.type+"/share/"+r.id,s,{headers:{"Content-Type":void 0},transformRequest:angular.identity}))}return i}}]),angular.module("cahierDeTexteApp").service("Redirection",["$state","User",function(e,t){this.doorman=function(r){t.get_user().then(function(t){if(0===_(r).size()||-1===_(r).indexOf(t.data.profil_actif.type)&&!t.data.profil_actif.admin){var n="404";switch(t.data.profil_actif.type){case"DIR":n="principal.enseignants";break;case"ENS":n="enseignant.emploi_du_temps";break;case"EVS":n="vie_scolaire.emploi_du_temps";break;case"TUT":case"ELV":n="eleve.emploi_du_temps"}e.go(n,e.params,{reload:!0,inherit:!0,notify:!0})}})}}]),angular.module("cahierDeTexteApp").service("PopupsCreneau",["$modal","APP_PATH",function(e,t){this.edition=function(r,n,i,a,s,u,o,c){c=!0,e.open({templateUrl:t+"/app/views/popup_edition.html",controller:"PopupEditionCtrl",resolve:{raw_data:function(){return r},matieres:function(){return n},classes:function(){return i},creneau:function(){return a},cours:function(){return s},devoirs:function(){return u}},backdrop:"static"}).result.then(function(e){o(e)}).finally(function(){c=!1})},this.display=function(r,n,i,a,s){s=!0,e.open({templateUrl:t+"/app/views/popup_display.html",controller:"PopupDisplayCtrl",resolve:{titre:function(){return r},cours:function(){return n},devoirs:function(){return i}},backdrop:"static"}).result.then(function(e){a(e)}).finally(function(){s=!1})}}]),angular.module("cahierDeTexteApp").service("PopupsCreneau",["$modal","APP_PATH",function(e,t){this.edition=function(r,n,i,a,s,u,o,c){c=!0,e.open({templateUrl:t+"/app/views/popup_edition.html",controller:"PopupEditionCtrl",resolve:{raw_data:function(){return r},matieres:function(){return n},classes:function(){return i},creneau:function(){return a},cours:function(){return s},devoirs:function(){return u}},backdrop:"static"}).result.then(function(e){o(e)}).finally(function(){c=!1})},this.display=function(r,n,i,a,s){s=!0,e.open({templateUrl:t+"/app/views/popup_display.html",controller:"PopupDisplayCtrl",resolve:{titre:function(){return r},cours:function(){return n},devoirs:function(){return i}},backdrop:"static"}).result.then(function(e){a(e)}).finally(function(){s=!1})}}]),angular.module("cahierDeTexteApp").service("Redirection",["$state","User",function(e,t){this.doorman=function(r){t.get_user().then(function(t){if(0===_(r).size()||-1===_(r).indexOf(t.data.profil_actif.type)&&!t.data.profil_actif.admin){var n="404";switch(t.data.profil_actif.type){case"DIR":n="principal.enseignants";break;case"ENS":n="enseignant.emploi_du_temps";break;case"EVS":n="vie_scolaire.emploi_du_temps";break;case"TUT":case"ELV":n="eleve.emploi_du_temps"}e.go(n,e.params,{reload:!0,inherit:!0,notify:!0})}})}}]),angular.module("cahierDeTexteApp").controller("VieScolaireCtrl",["$scope","$state",function(e,t){e.tabs=[{heading:"Emplois du Temps",uisref:"principal.emploi_du_temps",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name})}]),angular.module("cahierDeTexteApp").controller("FooterCtrl",["$scope","$state","$stateParams","VERSION","User",function(e,t,r,n,i){e.version=n,i.get_user().then(function(n){e.current_user=n.data,e.save_and_reload=function(){i.update_parameters(e.current_user.parametrage_cahier_de_textes).success(function(){t.transitionTo(t.current,r,{reload:!0,inherit:!0,notify:!0})})}})}]),angular.module("cahierDeTexteApp").controller("ImportCtrl",["$scope","$http","$upload","APP_PATH","Annuaire","current_user",function(e,t,r,n,i,a){e.in_progress=!1,e.result=!1,e.fichiers=null,e.launch_import=function(s){e.result=!1;for(var u=0;u<s.length;u++){var o=s[u];e.upload=r.upload({url:n+"/api/v1/import/pronote",method:"POST",file:o}).progress(function(t){e.in_progress=!0,console.log("percent: "+parseInt(100*t.loaded/t.total))}).error(function(){e.in_progress=!1}).success(function(r){e.in_progress=!1,e.result=r,e.identifie_objet=function(e){t.put(n+"/api/v1/import/mrpni/"+e.sha256+"/est/"+e.id_annuaire).success(function(){e.identified=!0})},e.identifie_massivement_objets=function(t){_(t).each(function(t){_(t.id_annuaire).isNull()||e.identifie_objet(t)})},_(e.result.rapport.matieres.error).isEmpty()||i.get_matieres().then(function(t){e.matieres=t.data}),_(e.result.rapport.enseignants.error).isEmpty()||(e.current_user=a,i.get_etablissement_enseignants(e.current_user.profil_actif.uai).then(function(t){e.enseignants=t.data})),_(e.result.rapport.regroupements.Classe.error).isEmpty()&&_(e.result.rapport.regroupements.Groupe.error).isEmpty()&&_(e.result.rapport.regroupements.PartieDeClasse.error).isEmpty()||(e.current_user=a,i.get_etablissement_regroupements(e.current_user.profil_actif.uai).then(function(t){e.regroupements=t.data}))})}},e.onFileSelect=function(t){e.fichiers=t}}]),angular.module("cahierDeTexteApp").controller("EleveDevoirsCtrl",["$scope","$sce","APP_PATH","DOCS_URL","API","Annuaire","Devoirs","Cours","CreneauEmploiDuTemps","current_user",function(e,t,r,n,i,a,s,u,o,c){var d=[];e.affiche_faits=!1,e.tri_ascendant=!0,e.popup_ouverte=!1,e.fait=function(e){s.fait({id:e})},e.current_user=c,i.query_types_de_devoir().$promise.then(function(r){d=r;var s=function(){e.from_date=moment().subtract(e.month_offset,"months").subtract(15,"days").toDate(),e.to_date=moment().subtract(e.month_offset,"months").add(15,"days").toDate(),i.query_devoirs({debut:e.from_date,fin:e.to_date,uid:"TUT"==e.current_user.profil_actif.type?e.current_user.enfant_actif.enfant.id_ent:null}).$promise.then(function(r){e.matieres={},e.all_devoirs=_(r).map(function(r){return r.type_devoir=_(d).findWhere({id:r.type_devoir_id}),o.get({id:r.creneau_emploi_du_temps_id}).$promise.then(function(t){r.creneau_emploi_du_temps=t,e.matieres[r.creneau_emploi_du_temps.matiere_id]=a.get_matiere(r.creneau_emploi_du_temps.matiere_id),r.matiere=e.matieres[r.creneau_emploi_du_temps.matiere_id]}),r.cours=_(r.cours_id).isNull()?null:u.get({id:r.cours_id}),_(r.ressources).each(function(e){e.url=t.trustAsResourceUrl(n+"/api/connector?cmd=file&target="+e.hash)}),r}),e.devoirs=e.all_devoirs})};e.filter_data=function(t){e.devoirs=_(t).isNull()?e.all_devoirs:_(e.all_devoirs).select(function(e){return e.creneau_emploi_du_temps.matiere_id==t})},e.month_offset=0,e.$watch("month_offset",function(){s()}),e.incr_offset=function(){e.month_offset++},e.decr_offset=function(){e.month_offset--},e.reset_offset=function(){e.month_offset=0}})}]),angular.module("cahierDeTexteApp").controller("IndexCtrl",["Redirection",function(e){e.doorman([])}]),angular.module("cahierDeTexteApp").controller("PrincipalCtrl",["$scope","$state",function(e,t){e.tabs=[{heading:"Validation des saisies par enseignant",uisref:"principal.enseignants",active:!1},{heading:"Tableaux de bord par classe",uisref:"principal.classes",active:!1},{heading:"Emplois du Temps",uisref:"principal.emploi_du_temps",active:!1},{heading:"Import Pronote",uisref:"principal.import",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name})}]),angular.module("cahierDeTexteApp").controller("EmploiDuTempsCtrl",["$scope","$q","$filter","CALENDAR_OPTIONS","CALENDAR_PARAMS","APP_PATH","API","Annuaire","EmploisDuTemps","PopupsCreneau","CreneauEmploiDuTemps","current_user",function(e,t,r,n,i,a,s,u,o,c,d,l){e.current_user=l;var p=!1,f=angular.identity;e.scope=e,e.selected_regroupement_id=void 0;var m=function(){var t=e.emploi_du_temps.fullCalendar("getView");g(t.visStart,t.visEnd)},h=function(t){var r=function(t){var r=this;if(this.details=t,this.allDay=!1,this.title="",this.regroupement=_(e.current_user.profil_actif.classes).findWhere({id:parseInt(this.details.regroupement_id)}),this.has_resources=_(t.cours).has("ressources")&&t.cours.ressources.length>0,_(t.devoirs).each(function(e){r.has_ressources=r.has_ressources&&_(e).has("ressources")&&e.ressources.length>0}),this.start=new Date(t.start),this.end=new Date(t.end),this.className="saisie-vide",u.get_matiere(t.matiere_id).$promise.then(function(e){r.title+=_(e.libelle_long).isUndefined()?t.matiere_id:e.libelle_long}),t.devoirs.length>0){if(this.className=_(_(t.devoirs).pluck("fait")).contains(!0)?"edt-devoir-fait":"edt-devoir-a-faire","edt-devoir-a-faire"==this.className){var n=_(t.devoirs).pluck("type_devoir_id");_(n).contains(2)?this.className="edt-devoir-note-maison":_(n).contains(1)&&(this.className="edt-devoir-note-surveille")}}else this.className="edt-cours",_(t.cours).isNull()||(this.className+="-saisie",_(t.cours.date_validation).isNull()||"ENS"!==e.current_user.profil_actif.type||(this.className+="-valide"));this.className+=("ELV"===e.current_user.profil_actif.type||"TUT"===e.current_user.profil_actif.type)&&_(t.cours).isNull()&&_(t.devoirs).isEmpty()?" unclickable-event":" clickable-event"};e.calendar.events[0]=_.chain(t).map(function(e){return new r(e)}).value()};e.refresh_calendar=function(){e.calendar.options.weekends=e.current_user.parametrage_cahier_de_textes.affichage_week_ends,h(f(e.raw_data))};var g=function(t,r){o.query({debut:t,fin:r,uai:e.current_user.profil_actif.uai,uid:"TUT"==e.current_user.profil_actif.type?e.current_user.enfant_actif.enfant.id_ent:null}).$promise.then(function(t){e.raw_data=t,e.refresh_calendar()})};e.calendar={options:n,events:[]},e.calendar.options.viewRender=function(t){e.current_user.date=t.visStart,g(t.visStart,t.visEnd)},e.calendar.options.eventRender=function(t,r){var n=r.find(".fc-event-title");if(e.current_user.profil_actif.classes.length>0){var i="undefined"!==t.regroupement?t.regroupement.libelle:"";n.prepend(i+" - ")}t.has_resources&&n.prepend('<i class="glyphicon glyphicon-paperclip"></i>')},e.calendar.options.weekends=e.current_user.parametrage_cahier_de_textes.affichage_week_ends;var v=function(t,r){return _(e.selected_regroupement_id).isUndefined()||_(e.selected_regroupement_id).isNull()?t:_(t).filter(function(e){return e.regroupement_id==r})},y=function(e,t,r){return r?_(e).filter(function(e){return e.enseignant_id==t}):e};if(("EVS"==e.current_user.profil_actif.type||"DIR"==e.current_user.profil_actif.type)&&(f=function(t){var r=t;return r=v(r,e.selected_regroupement_id)},e.selected_regroupement_id=e.current_user.profil_actif.classes[0].id),"ENS"==e.current_user.profil_actif.type&&(e.uniquement_mes_creneaux=!0,e.calendar.options.selectable=!0,e.calendar.options.editable=!0,f=function(t){var r=t;return r=v(r,e.selected_regroupement_id),r=y(r,e.current_user.uid,e.uniquement_mes_creneaux)},e.calendar.options.eventClick=function(t){p||d.get({id:t.details.creneau_emploi_du_temps_id}).$promise.then(function(r){r.dirty=!1,r.heure_debut=t.start,r.heure_fin=t.end,r.regroupement_id=t.details.regroupement_id,c.edition(e.raw_data,e.current_user.profil_actif.matieres,e.current_user.profil_actif.classes,r,t.details.cours,t.details.devoirs,m,p)})},e.calendar.options.select=function(t,n){if(n-t==18e5&&(n=moment(n).add(30,"minutes").toDate()),!p){t=r("correctTimeZone")(t),n=r("correctTimeZone")(n);var i=_(e.selected_regroupement_id).isNull()?null:""+e.selected_regroupement_id,a=new d({regroupement_id:i,jour_de_la_semaine:t.getDay()+1,heure_debut:new Date(new Date(t)).toISOString(),heure_fin:new Date(new Date(n)).toISOString(),matiere_id:""});a.$save().then(function(){a.dirty=!0,a.heure_debut=t,a.heure_fin=n,a.regroupement_id=i,c.edition(e.raw_data,e.current_user.profil_actif.matieres,e.current_user.profil_actif.classes,a,null,[],m,p),e.emploi_du_temps.fullCalendar("unselect")})}}),"TUT"===e.current_user.profil_actif.type&&(e.uid_enfant_actif=e.current_user.enfants[0].enfant.id_ent,e.reload_data=m),("ELV"==e.current_user.profil_actif.type||"TUT"==e.current_user.profil_actif.type||"EVS"==e.current_user.profil_actif.type||"DIR"==e.current_user.profil_actif.type)&&(e.calendar.options.eventClick=function(e){!p&&(e.details.devoirs.length>0||!_(e.details.cours).isNull()&&_(e.details.cours).has("contenu"))&&c.display(e.title,e.details.cours,e.details.devoirs,m,p)}),e.current_user.date){var b=moment(e.current_user.date);e.calendar.options.year=b.year(),e.calendar.options.month=b.month(),e.calendar.options.date=b.date()}}]),angular.module("cahierDeTexteApp").controller("HeaderCtrl",["$scope","$state","User","Redirection",function(e,t,r,n){e.embedded=window!=window.top,r.get_user().success(function(t){e.current_user=t}),e.reload=function(){n.doorman([])}}]),angular.module("cahierDeTexteApp").controller("PopupDisplayCtrl",["$scope","$sce","$modalInstance","APP_PATH","DOCS_URL","Cours","Devoirs","User","titre","cours","devoirs",function(e,t,r,n,i,a,s,u,o,c,d){e.app_path=n,e.titre=o,e.date=null,_(c).isNull()||(e.cours=a.get({id:c.id}),e.cours.$promise.then(function(){_(e.cours.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)})}),e.cours.$promise.then(function(t){e.date=e.cours.date_cours,_(t.devoirs).each(function(e){e.tooltip=e.contenu,e.temps_estime>0&&(e.tooltip='<span><i class="picto temps"></i>'+5*e.temps_estime+" minutes</span><hr>"+e.tooltip)})})),e.devoirs=d.map(function(e){return s.get({id:e.id})}),_(e.devoirs).each(function(e){e.$promise.then(function(){_(e.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)})})}),_(e.date).isNull()&&!_(e.devoirs).isEmpty()&&e.devoirs[0].$promise.then(function(){e.date=e.devoirs[0].date_due}),e.tab_SP_active=_(e.devoirs).isEmpty(),e.fermer=function(){r.close(e)},u.get_user().then(function(t){e.current_user=t.data,"ELV"===e.current_user.profil_actif.type&&(e.fait=function(e){s.fait({id:e})})})}]),angular.module("cahierDeTexteApp").controller("PopupDisplayCtrl",["$scope","$sce","$modalInstance","APP_PATH","DOCS_URL","Cours","Devoirs","User","titre","cours","devoirs",function(e,t,r,n,i,a,s,u,o,c,d){e.app_path=n,e.titre=o,e.date=null,_(c).isNull()||(e.cours=a.get({id:c.id}),e.cours.$promise.then(function(){_(e.cours.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)})}),e.cours.$promise.then(function(t){e.date=e.cours.date_cours,_(t.devoirs).each(function(e){e.tooltip=e.contenu,e.temps_estime>0&&(e.tooltip='<span><i class="picto temps"></i>'+5*e.temps_estime+" minutes</span><hr>"+e.tooltip)})})),e.devoirs=d.map(function(e){return s.get({id:e.id})}),_(e.devoirs).each(function(e){e.$promise.then(function(){_(e.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)})})}),_(e.date).isNull()&&!_(e.devoirs).isEmpty()&&e.devoirs[0].$promise.then(function(){e.date=e.devoirs[0].date_due}),e.tab_SP_active=_(e.devoirs).isEmpty(),e.fermer=function(){r.close(e)},u.get_user().then(function(t){e.current_user=t.data,"ELV"===e.current_user.profil_actif.type&&(e.fait=function(e){s.fait({id:e})})})}]),angular.module("cahierDeTexteApp").controller("CahierDeTextesCtrl",["$scope","$sce","$q","APP_PATH","DOCS_URL","API","Annuaire","EmploisDuTemps","current_user","PopupsCreneau","CreneauEmploiDuTemps",function(e,t,r,n,i,a,s,u,o,c,d){e.current_user=o;var l=[],p=[],f=!1;e.scope=e,e.selected_regroupement_id=null,e.selected_creneau_vide=null;var m=function(t){var r=_.chain(t).filter(function(t){return t.enseignant_id===e.current_user.uid}).reject(function(e){return _(e.cours).isEmpty()}).map(function(e){return e.devoirs.ouvert=!0,e}).value();return r},h=function(t){var r=_.chain(t).filter(function(t){return t.enseignant_id===e.current_user.uid}).filter(function(e){return _(e.cours).isEmpty()}).value();return r},g=function(e){return _.chain(e).pluck("matiere_id").uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return[e,s.get_matiere(e)]}).object().value()};e.period_offset=e.current_user.date?moment(moment()-moment(e.current_user.date)).months():0,e.$watch("period_offset",function(){v()}),e.incr_offset=function(){e.period_offset++},e.decr_offset=function(){e.period_offset--},e.reset_offset=function(){e.period_offset=0};var v=function(){e.current_user.date=moment().subtract(e.period_offset,"months").toDate(),e.from_date=moment(e.current_user.date).subtract(2,"weeks").startOf("week").toDate(),e.to_date=moment(e.current_user.date).add(2,"weeks").endOf("week").toDate(),u.query({debut:e.from_date,fin:e.to_date,uai:e.current_user.profil_actif.uai}).$promise.then(function(r){e.raw_data=r,l=g(e.raw_data),_(e.raw_data).each(function(e){e.matiere=s.get_matiere(e.matiere_id),e.regroupement=s.get_regroupement(e.regroupement_id)}),e.creneaux_vides=h(e.raw_data),e.creneaux_saisies=m(e.raw_data),_(e.creneaux_saisies).each(function(e){_(e.cours.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)}),_(e.devoirs).each(function(e){_(e.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)})})}),e.selected_creneau_vide=null})};e.popup_callback=v,e.edition_creneau=function(t){d.get({id:t.creneau_emploi_du_temps_id}).$promise.then(function(r){r.dirty=!1,r.heure_debut=new Date(t.start),r.heure_fin=new Date(t.end),r.regroupement_id=t.regroupement_id,c.edition(e.raw_data,p,e.classes,r,t.cours,t.devoirs,e.popup_callback,f)})},p=e.current_user.profil_actif.matieres,e.classes=e.current_user.profil_actif.classes}]),angular.module("cahierDeTexteApp").controller("EnseignantCtrl",["$scope","$state","current_user",function(e,t,r){e.tabs=[{heading:"Emploi du temps",uisref:"enseignant.emploi_du_temps",active:!1},{heading:"Cahier de textes",uisref:"enseignant.cahier_de_textes",active:!1},{heading:"Statistiques",uisref:"enseignant.stats",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name}),e.current_user=r
}]),angular.module("cahierDeTexteApp").controller("PrincipalEnseignantsCtrl",["$scope","$locale","THEME","$q","API","Annuaire","current_user","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,r,n,i,a,s,u,o){e.scope=e,e.annee=_(t.DATETIME_FORMATS.MONTH).toArray(),e.selected_regroupement_id=null,e.selected_mois=null,e.classes=[],e.details_enseignants={},e.pieChart=u(),e.barChart=o(),e.pieChart.populate=function(t){e.pieChart.data=[{label:"saisies",value:t.filled-t.validated},{label:"visas",value:t.validated}]},e.barChart.populate=function(t){var r={key:"saisies",values:[]},n={key:"visas",values:[]};_(t).each(function(t){r.values.push([e.details_enseignants[t.enseignant_id].full_name,t.filled]),n.values.push([e.details_enseignants[t.enseignant_id].full_name,t.validated])}),e.barChart.data=[n,r]},e.htmlify_classes_list=function(e){return"Classes : <ul><li>"+_(e).map(function(e){return e.classe_libelle}).join("</li><li>")+"</li></ul>"},e.htmlify_matieres_list=function(e){return"Matières : <ul><li>"+e.join("</li><li>")+"</li></ul>"},e.individualCharts={enseignants:[],populate:function(t,r){e.individualCharts.enseignants=_(t).map(function(e){var t={enseignant:r[e.enseignant_id],pieChart:u()};return t.pieChart.data=[{label:"visas",value:e.validated},{label:"saisies",value:e.filled-e.validated}],t})}},e.extract_classes_promises=function(e){return _.chain(e).toArray().pluck("classes").flatten().pluck("classe_id").uniq().map(function(e){return a.get_regroupement(e).$promise}).value()},e.extract_details_enseignants_promises=function(e){return _(e).pluck("enseignant_id").map(function(e){return a.get_user(e).$promise})},e.process_data=function(){void 0!==e.raw_data&&(e.displayed_data=e.raw_data,null!=e.selected_regroupement_id&&(e.displayed_data=_.chain(e.displayed_data).reject(function(t){return _.chain(e.details_enseignants[t.enseignant_id].classes).findWhere({classe_id:parseInt(e.selected_regroupement_id)}).isUndefined().value()}).map(function(t){return{enseignant_id:t.enseignant_id,classes:_(t.classes).reject(function(t){return t.regroupement_id!=e.selected_regroupement_id})}}).value()),null!=e.selected_mois&&(e.displayed_data=_(e.displayed_data).map(function(t){return{enseignant_id:t.enseignant_id,classes:_(t.classes).map(function(t){return{regroupement_id:t.regroupement_id,statistiques:_(t.statistiques).reject(function(t){return t.month!=e.selected_mois})}})}})),e.displayed_data.filled=0,e.displayed_data.validated=0,_(e.displayed_data).each(function(t){var r=_(t.classes).reduce(function(e,t){var r=_(t.statistiques).reduce(function(e,t){return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});return{filled:e.filled+r.filled,validated:e.validated+r.validated}},{filled:0,validated:0});t.filled=r.filled,t.validated=r.validated,e.displayed_data.filled+=r.filled,e.displayed_data.validated+=r.validated}),e.pieChart.populate(e.displayed_data),e.individualCharts.populate(e.displayed_data,e.details_enseignants),e.barChart.populate(e.displayed_data))},i.query_enseignants({uai:s.profil_actif.uai}).$promise.then(function(t){e.raw_data=_(t).reject(function(e){return""===e.enseignant_id}),n.all(e.extract_details_enseignants_promises(e.raw_data)).then(function(t){_(t).each(function(t){t.matieres=_.chain(t.classes).pluck("matiere_libelle").uniq().value(),e.details_enseignants[t.id_ent]=t}),n.all(e.extract_classes_promises(e.details_enseignants)).then(function(t){e.classes=_(t).map(function(e){return{id:e.id,libelle:null!==e.libelle?e.libelle:e.libelle_aaf}}),e.process_data()})})})}]),angular.module("cahierDeTexteApp").controller("ImportCtrl",["$scope","$http","$upload","APP_PATH","Annuaire","current_user",function(e,t,r,n,i,a){e.in_progress=!1,e.result=!1,e.fichiers=null,e.launch_import=function(s){e.result=!1;for(var u=0;u<s.length;u++){var o=s[u];e.upload=r.upload({url:n+"/api/v1/import/pronote",method:"POST",file:o}).progress(function(t){e.in_progress=!0,console.log("percent: "+parseInt(100*t.loaded/t.total))}).error(function(){e.in_progress=!1}).success(function(r){e.in_progress=!1,e.result=r,e.identifie_objet=function(e){t.put(n+"/api/v1/import/mrpni/"+e.sha256+"/est/"+e.id_annuaire).success(function(){e.identified=!0})},e.identifie_massivement_objets=function(t){_(t).each(function(t){_(t.id_annuaire).isNull()||e.identifie_objet(t)})},_(e.result.rapport.matieres.error).isEmpty()||i.get_matieres().then(function(t){e.matieres=t.data}),_(e.result.rapport.enseignants.error).isEmpty()||(e.current_user=a,i.get_etablissement_enseignants(e.current_user.profil_actif.uai).then(function(t){e.enseignants=t.data})),_(e.result.rapport.regroupements.Classe.error).isEmpty()&&_(e.result.rapport.regroupements.Groupe.error).isEmpty()&&_(e.result.rapport.regroupements.PartieDeClasse.error).isEmpty()||(e.current_user=a,i.get_etablissement_regroupements(e.current_user.profil_actif.uai).then(function(t){e.regroupements=t.data}))})}},e.onFileSelect=function(t){e.fichiers=t}}]),angular.module("cahierDeTexteApp").controller("EleveDevoirsCtrl",["$scope","$sce","APP_PATH","DOCS_URL","API","Annuaire","Devoirs","Cours","CreneauEmploiDuTemps","current_user",function(e,t,r,n,i,a,s,u,o,c){var d=[];e.affiche_faits=!1,e.tri_ascendant=!0,e.popup_ouverte=!1,e.fait=function(e){s.fait({id:e})},e.current_user=c,i.query_types_de_devoir().$promise.then(function(r){d=r;var s=function(){e.from_date=moment().subtract(e.month_offset,"months").subtract(15,"days").toDate(),e.to_date=moment().subtract(e.month_offset,"months").add(15,"days").toDate(),i.query_devoirs({debut:e.from_date,fin:e.to_date,uid:"TUT"==e.current_user.profil_actif.type?e.current_user.enfant_actif.enfant.id_ent:null}).$promise.then(function(r){e.matieres={},e.all_devoirs=_(r).map(function(r){return r.type_devoir=_(d).findWhere({id:r.type_devoir_id}),o.get({id:r.creneau_emploi_du_temps_id}).$promise.then(function(t){r.creneau_emploi_du_temps=t,e.matieres[r.creneau_emploi_du_temps.matiere_id]=a.get_matiere(r.creneau_emploi_du_temps.matiere_id),r.matiere=e.matieres[r.creneau_emploi_du_temps.matiere_id]}),r.cours=_(r.cours_id).isNull()?null:u.get({id:r.cours_id}),_(r.ressources).each(function(e){e.url=t.trustAsResourceUrl(n+"/api/connector?cmd=file&target="+e.hash)}),r}),e.devoirs=e.all_devoirs})};e.filter_data=function(t){e.devoirs=_(t).isNull()?e.all_devoirs:_(e.all_devoirs).select(function(e){return e.creneau_emploi_du_temps.matiere_id==t})},e.month_offset=0,e.$watch("month_offset",function(){s()}),e.incr_offset=function(){e.month_offset++},e.decr_offset=function(){e.month_offset--},e.reset_offset=function(){e.month_offset=0}})}]),angular.module("cahierDeTexteApp").controller("EmploiDuTempsCtrl",["$scope","$q","$filter","CALENDAR_OPTIONS","CALENDAR_PARAMS","APP_PATH","API","Annuaire","EmploisDuTemps","PopupsCreneau","CreneauEmploiDuTemps","current_user",function(e,t,r,n,i,a,s,u,o,c,d,l){e.current_user=l;var p=!1,f=angular.identity;e.scope=e,e.selected_regroupement_id=void 0;var m=function(){var t=e.emploi_du_temps.fullCalendar("getView");g(t.visStart,t.visEnd)},h=function(t){var r=function(t){var r=this;if(this.details=t,this.allDay=!1,this.title="",this.regroupement=_(e.current_user.profil_actif.classes).findWhere({id:parseInt(this.details.regroupement_id)}),this.has_resources=_(t.cours).has("ressources")&&t.cours.ressources.length>0,_(t.devoirs).each(function(e){r.has_ressources=r.has_ressources&&_(e).has("ressources")&&e.ressources.length>0}),this.start=new Date(t.start),this.end=new Date(t.end),this.className="saisie-vide",u.get_matiere(t.matiere_id).$promise.then(function(e){r.title+=_(e.libelle_long).isUndefined()?t.matiere_id:e.libelle_long}),t.devoirs.length>0){if(this.className=_(_(t.devoirs).pluck("fait")).contains(!0)?"edt-devoir-fait":"edt-devoir-a-faire","edt-devoir-a-faire"==this.className){var n=_(t.devoirs).pluck("type_devoir_id");_(n).contains(2)?this.className="edt-devoir-note-maison":_(n).contains(1)&&(this.className="edt-devoir-note-surveille")}}else this.className="edt-cours",_(t.cours).isNull()||(this.className+="-saisie",_(t.cours.date_validation).isNull()||"ENS"!==e.current_user.profil_actif.type||(this.className+="-valide"));this.className+=("ELV"===e.current_user.profil_actif.type||"TUT"===e.current_user.profil_actif.type)&&_(t.cours).isNull()&&_(t.devoirs).isEmpty()?" unclickable-event":" clickable-event"};e.calendar.events[0]=_.chain(t).map(function(e){return new r(e)}).value()};e.refresh_calendar=function(){e.calendar.options.weekends=e.current_user.parametrage_cahier_de_textes.affichage_week_ends,h(f(e.raw_data))};var g=function(t,r){o.query({debut:t,fin:r,uai:e.current_user.profil_actif.uai,uid:"TUT"==e.current_user.profil_actif.type?e.current_user.enfant_actif.enfant.id_ent:null}).$promise.then(function(t){e.raw_data=t,e.refresh_calendar()})};e.calendar={options:n,events:[]},e.calendar.options.viewRender=function(t){e.current_user.date=t.visStart,g(t.visStart,t.visEnd)},e.calendar.options.eventRender=function(t,r){var n=r.find(".fc-event-title");if(e.current_user.profil_actif.classes.length>0){var i="undefined"!==t.regroupement?t.regroupement.libelle:"";n.prepend(i+" - ")}t.has_resources&&n.prepend('<i class="glyphicon glyphicon-paperclip"></i>')},e.calendar.options.weekends=e.current_user.parametrage_cahier_de_textes.affichage_week_ends;var v=function(t,r){return _(e.selected_regroupement_id).isUndefined()||_(e.selected_regroupement_id).isNull()?t:_(t).filter(function(e){return e.regroupement_id==r})},y=function(e,t,r){return r?_(e).filter(function(e){return e.enseignant_id==t}):e};if(("EVS"==e.current_user.profil_actif.type||"DIR"==e.current_user.profil_actif.type)&&(f=function(t){var r=t;return r=v(r,e.selected_regroupement_id)},e.selected_regroupement_id=e.current_user.profil_actif.classes[0].id),"ENS"==e.current_user.profil_actif.type&&(e.uniquement_mes_creneaux=!0,e.calendar.options.selectable=!0,e.calendar.options.editable=!0,f=function(t){var r=t;return r=v(r,e.selected_regroupement_id),r=y(r,e.current_user.uid,e.uniquement_mes_creneaux)},e.calendar.options.eventClick=function(t){p||d.get({id:t.details.creneau_emploi_du_temps_id}).$promise.then(function(r){r.dirty=!1,r.heure_debut=t.start,r.heure_fin=t.end,r.regroupement_id=t.details.regroupement_id,c.edition(e.raw_data,e.current_user.profil_actif.matieres,e.current_user.profil_actif.classes,r,t.details.cours,t.details.devoirs,m,p)})},e.calendar.options.select=function(t,n){if(n-t==18e5&&(n=moment(n).add(30,"minutes").toDate()),!p){t=r("correctTimeZone")(t),n=r("correctTimeZone")(n);var i=_(e.selected_regroupement_id).isNull()?null:""+e.selected_regroupement_id,a=new d({regroupement_id:i,jour_de_la_semaine:t.getDay()+1,heure_debut:new Date(new Date(t)).toISOString(),heure_fin:new Date(new Date(n)).toISOString(),matiere_id:""});a.$save().then(function(){a.dirty=!0,a.heure_debut=t,a.heure_fin=n,a.regroupement_id=i,c.edition(e.raw_data,e.current_user.profil_actif.matieres,e.current_user.profil_actif.classes,a,null,[],m,p),e.emploi_du_temps.fullCalendar("unselect")})}}),"TUT"===e.current_user.profil_actif.type&&(e.uid_enfant_actif=e.current_user.enfants[0].enfant.id_ent,e.reload_data=m),("ELV"==e.current_user.profil_actif.type||"TUT"==e.current_user.profil_actif.type||"EVS"==e.current_user.profil_actif.type||"DIR"==e.current_user.profil_actif.type)&&(e.calendar.options.eventClick=function(e){!p&&(e.details.devoirs.length>0||!_(e.details.cours).isNull()&&_(e.details.cours).has("contenu"))&&c.display(e.title,e.details.cours,e.details.devoirs,m,p)}),e.current_user.date){var b=moment(e.current_user.date);e.calendar.options.year=b.year(),e.calendar.options.month=b.month(),e.calendar.options.date=b.date()}}]),angular.module("cahierDeTexteApp").controller("PrincipalEnseignantsCtrl",["$scope","$locale","THEME","$q","API","Annuaire","current_user","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,r,n,i,a,s,u,o){e.scope=e,e.annee=_(t.DATETIME_FORMATS.MONTH).toArray(),e.selected_regroupement_id=null,e.selected_mois=null,e.classes=[],e.details_enseignants={},e.pieChart=u(),e.barChart=o(),e.pieChart.populate=function(t){e.pieChart.data=[{label:"saisies",value:t.filled-t.validated},{label:"visas",value:t.validated}]},e.barChart.populate=function(t){var r={key:"saisies",values:[]},n={key:"visas",values:[]};_(t).each(function(t){r.values.push([e.details_enseignants[t.enseignant_id].full_name,t.filled]),n.values.push([e.details_enseignants[t.enseignant_id].full_name,t.validated])}),e.barChart.data=[n,r]},e.htmlify_classes_list=function(e){return"Classes : <ul><li>"+_(e).map(function(e){return e.classe_libelle}).join("</li><li>")+"</li></ul>"},e.htmlify_matieres_list=function(e){return"Matières : <ul><li>"+e.join("</li><li>")+"</li></ul>"},e.individualCharts={enseignants:[],populate:function(t,r){e.individualCharts.enseignants=_(t).map(function(e){var t={enseignant:r[e.enseignant_id],pieChart:u()};return t.pieChart.data=[{label:"visas",value:e.validated},{label:"saisies",value:e.filled-e.validated}],t})}},e.extract_classes_promises=function(e){return _.chain(e).toArray().pluck("classes").flatten().pluck("classe_id").uniq().map(function(e){return a.get_regroupement(e).$promise}).value()},e.extract_details_enseignants_promises=function(e){return _(e).pluck("enseignant_id").map(function(e){return a.get_user(e).$promise})},e.process_data=function(){void 0!==e.raw_data&&(e.displayed_data=e.raw_data,null!=e.selected_regroupement_id&&(e.displayed_data=_.chain(e.displayed_data).reject(function(t){return _.chain(e.details_enseignants[t.enseignant_id].classes).findWhere({classe_id:parseInt(e.selected_regroupement_id)}).isUndefined().value()}).map(function(t){return{enseignant_id:t.enseignant_id,classes:_(t.classes).reject(function(t){return t.regroupement_id!=e.selected_regroupement_id})}}).value()),null!=e.selected_mois&&(e.displayed_data=_(e.displayed_data).map(function(t){return{enseignant_id:t.enseignant_id,classes:_(t.classes).map(function(t){return{regroupement_id:t.regroupement_id,statistiques:_(t.statistiques).reject(function(t){return t.month!=e.selected_mois})}})}})),e.displayed_data.filled=0,e.displayed_data.validated=0,_(e.displayed_data).each(function(t){var r=_(t.classes).reduce(function(e,t){var r=_(t.statistiques).reduce(function(e,t){return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});return{filled:e.filled+r.filled,validated:e.validated+r.validated}},{filled:0,validated:0});t.filled=r.filled,t.validated=r.validated,e.displayed_data.filled+=r.filled,e.displayed_data.validated+=r.validated}),e.pieChart.populate(e.displayed_data),e.individualCharts.populate(e.displayed_data,e.details_enseignants),e.barChart.populate(e.displayed_data))},i.query_enseignants({uai:s.profil_actif.uai}).$promise.then(function(t){e.raw_data=_(t).reject(function(e){return""===e.enseignant_id}),n.all(e.extract_details_enseignants_promises(e.raw_data)).then(function(t){_(t).each(function(t){t.matieres=_.chain(t.classes).pluck("matiere_libelle").uniq().value(),e.details_enseignants[t.id_ent]=t}),n.all(e.extract_classes_promises(e.details_enseignants)).then(function(t){e.classes=_(t).map(function(e){return{id:e.id,libelle:null!==e.libelle?e.libelle:e.libelle_aaf}}),e.process_data()})})})}]),angular.module("cahierDeTexteApp").controller("PrincipalClassesCtrl",["$scope","THEME","$locale","$q","API","Annuaire","current_user","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,r,n,i,a,s,u,o){e.empty=!1,e.scope=e,e.raw_data=[],e.displayed_data=[],e.classes={},e.matieres=[],e.annee=_(r.DATETIME_FORMATS.MONTH).toArray(),e.selected_regroupement_id=null,e.selected_mois=null,e.selected_matiere=null,e.global_stats={filled:0,validated:0},e.pieChart=u(),e.barChart=o(),e.pieChart.populate=function(t){e.pieChart.data=[{label:"saisie",value:t.filled-t.validated},{label:"valide",value:t.validated}]},e.barChart.populate=function(t){var r=[];_(12).times(function(t){r.push([e.annee[t],0])});var n=t.reduce(function(e,t){return _(12).times(function(r){e.filled[r][1]+=t.mensuel.filled[r],e.validated[r][1]+=t.mensuel.validated[r]}),e},{filled:angular.copy(r),validated:angular.copy(r)});e.barChart.data=[],e.barChart.data.push({key:"saisie",values:n.filled}),e.barChart.data.push({key:"valide",values:n.validated})},e.individualCharts={classes:[],populate:function(t,r){var n=_.chain(r).map(function(e){return[e.id,e]}).object().value();e.individualCharts.classes=_(t).map(function(e){var t={regroupement:n[e.regroupement_id],pieChart:u()};return t.pieChart.data=[{label:"saisie",value:e.filled-e.validated},{label:"valide",value:e.validated}],t})}},e.extract_matieres=function(e){return _.chain(e).pluck("matieres").flatten().pluck("matiere_id").uniq().compact().map(function(e){var t={id:e,libelle:"Matière inconnue !"};return a.get_matiere(e).$promise.then(function(e){t.libelle=e.libelle_long}),t}).value()},e.extract_classes=function(e){return _.chain(e).pluck("regroupement_id").map(function(e){return a.get_regroupement(e).$promise}).value()},e.process_data=function(){if(e.raw_data.length>0){e.displayed_data=e.raw_data,null!=e.selected_matiere&&(e.displayed_data=e.displayed_data.map(function(t){var r=_(t.matieres).filter(function(t){return t.matiere_id==e.selected_matiere});return{regroupement_id:t.regroupement_id,matieres:r}})),null!=e.selected_mois&&(e.displayed_data=e.displayed_data.map(function(t){return{regroupement_id:t.regroupement_id,matieres:t.matieres.map(function(t){return{matiere_id:t.matiere_id,mois:_(t.mois).filter(function(t){return t.mois==e.selected_mois})}})}})),_(e.displayed_data).each(function(e){e.mensuel=e.matieres.reduce(function(e,t){return _(t.mois).each(function(t){e.filled[t.mois-1]+=t.filled,e.validated[t.mois-1]+=t.validated}),e},{filled:[0,0,0,0,0,0,0,0,0,0,0,0],validated:[0,0,0,0,0,0,0,0,0,0,0,0]}),e.filled=e.mensuel.filled.reduce(function(e,t){return e+t},0),e.validated=e.mensuel.validated.reduce(function(e,t){return e+t},0)});var t=e.displayed_data.reduce(function(e,t){return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});e.displayed_data.filled=t.filled,e.displayed_data.validated=t.validated,e.individualCharts.populate(e.displayed_data,e.classes),e.pieChart.populate(e.displayed_data),e.barChart.populate(e.displayed_data)}},i.query_classes({uai:s.profil_actif.uai}).$promise.then(function(t){e.raw_data=t,e.empty=0==_(e.raw_data[0]).size(),e.empty||n.all(e.extract_matieres(e.raw_data)).then(function(t){e.matieres=t,n.all(e.extract_classes(e.raw_data)).then(function(t){e.classes=t,e.process_data()})})})}]),angular.module("cahierDeTexteApp").controller("PopupEditionCtrl",["$scope","$filter","$q","$sce","$modalInstance","APP_PATH","DOCS_URL","SEMAINES_VACANCES","ZONE","Documents","API","CreneauEmploiDuTemps","Cours","Devoirs","User","cours","devoirs","creneau","raw_data","classes","matieres",function(e,t,r,n,i,a,s,u,o,c,d,l,p,f,m,h,g,v,y,b,A){e.app_path=a,e.DOCS_URL_login=n.trustAsResourceUrl(s+"/login"),e.ZONE=o,e.faulty_docs_app=!1,e.erreurs=[],e.dirty=!1,e.mode_duplication=!1,e.scope=e,m.get_user().then(function(a){e.current_user=a.data;var m=function(t){var r=new p({creneau_emploi_du_temps_id:t.id,date_cours:new Date(t.heure_debut).toISOString(),date_validation:null,enseignant_id:e.current_user.uid,contenu:""});return r.devoirs=[],r.create=!0,r};e.is_dirty=function(t){t="undefined"!=typeof t?t:null,e.dirty=e.dirty||null===t||null!==t&&t.contenu.length>0},e.classes=b,e.matieres=A,e.creneau=v,e.creneau.en_creation=_(e.creneau.matiere_id).isEmpty()||"undefined"===e.creneau.regroupement_id,e.creneau.etranger=!e.creneau.en_creation&&!_.chain(e.creneau.enseignants).pluck("enseignant_id").include(e.current_user.uid).value(),e.creneau.previous_regroupement_id=e.creneau.regroupement_id,_(v.vierge).isUndefined()&&(v.vierge=!0),e.creneau.en_creation?(e.creneau.tmp_heure_debut=t("correctTimeZoneToGMT")(e.creneau.heure_debut),e.creneau.tmp_heure_fin=t("correctTimeZoneToGMT")(e.creneau.heure_fin),e.classe=_(e.classes).first(),e.matiere=_(e.matieres).first()):(e.creneau.tmp_heure_debut=angular.copy(e.creneau.heure_debut),e.creneau.tmp_heure_fin=angular.copy(e.creneau.heure_fin),e.classe=_(e.classes).findWhere({id:parseInt(e.creneau.regroupement_id)}),e.matiere=_(e.matieres).findWhere({id:e.creneau.matiere_id})),e.creneau.n_week=moment(e.creneau.tmp_heure_debut).week();var y=function(e){var t=e.toString(2),r="";return _(53-t.length).times(function(){r+="0"}),t=r+t,_(t.split("").map(function(e){return parseInt(e)}).reverse()).rest()},T=function(e){return parseInt(e.reverse().join("")+"0",2)};e.sont_ce_les_vacances=function(e,t){return-1!=u[t].indexOf(e)};var P=function(){var t=[];return _(52).times(function(r){t.push(e.sont_ce_les_vacances(r+1,o)?0:1)}),t};if(e.semaines_actives={regroupement:[]},e.apply_template=function(t){var r=[];switch(t){case"tout":e.semaines_actives.regroupement=P();break;case"rien":_(52).times(function(){r.push(0)}),e.semaines_actives.regroupement=r;break;case"paires":_(52).times(function(t){r.push(e.sont_ce_les_vacances(t+1,o)||(t+1)%2!=0?0:1)}),e.semaines_actives.regroupement=r;break;case"impaires":_(52).times(function(t){r.push(e.sont_ce_les_vacances(t+1,o)||(t+1)%2!=1?0:1)}),e.semaines_actives.regroupement=r;break;case"unique":_(52).times(function(t){r.push(t+1==e.creneau.n_week?1:0)}),e.semaines_actives.regroupement=r;break;case"inverser":e.semaines_actives.regroupement=_(e.semaines_actives.regroupement).map(function(t,r){return 0!=t||e.sont_ce_les_vacances(r+1,o)?0:1});break;case"reinitialiser":e.semaines_actives.regroupement=e.creneau.en_creation?P():y(_(v.regroupements).findWhere({regroupement_id:v.regroupement_id}).semaines_de_presence)}},e.apply_template("reinitialiser"),e.fermer=function(){i.close(e)},e.effacer_creneau=function(){swal({title:"Ceci supprimera le créneau à compter du "+t("date")(v.heure_debut,"fullDate"),text:"Le créneau avec ses séquences pédagogiques et devoirs associés restera visible pour les dates antérieures.",type:"warning",showCancelButton:!0,confirmButtonColor:"#ff6b55",confirmButtonText:"Confirmer",cancelButtonText:"Annuler"},function(){l.delete({id:e.creneau.id,date_creneau:e.creneau.heure_debut}).$promise.then(function(){e.fermer()})})},e.annuler=function(){e.creneau.en_creation&&_(e.creneau.matiere_id).isEmpty()&&"undefined"===e.creneau.regroupement_id?e.effacer_creneau():(e.dirty=!1,e.fermer())},e.valider=function(){e.erreurs=[];var n=[];if(e.creneau.en_creation)e.creneau.matiere_id=e.matiere.id,e.creneau.regroupement_id=e.classe.id,e.creneau.heure_debut=t("correctTimeZone")(e.creneau.tmp_heure_debut),e.creneau.heure_fin=t("correctTimeZone")(e.creneau.tmp_heure_fin),e.creneau.semaines_de_presence_regroupement=T(e.semaines_actives.regroupement),e.creneau.$update();else{var i=function(t,i){_(t).each(function(t){if(_(t).has("contenu")&&t.contenu.length>0){var a=r.defer();t.create?(t.regroupement_id=e.classe.id,_(i).isNull()||(t.cours_id=i.id),t.$save().then(function(e){t.id=e.id,a.resolve(e)},function(t){e.erreurs.unshift({status:t.status,message:t.data.error}),a.reject(t)})):t.$update().then(function(e){t.id=e.id,a.resolve(e)},function(t){e.erreurs.unshift({status:t.status,message:t.data.error}),a.reject(t)}),n.push(a.promise)}})};if(_(e.cours).has("contenu")&&e.cours.contenu.length>0||e.cours.devoirs.length>0){var a=r.when(!0),s=_(e.cours.devoirs).map(function(e){return new f(e)});e.cours.create?(e.cours.regroupement_id=e.classe.id,e.cours.creneau_emploi_du_temps_id=e.creneau.id,a=e.cours.$save()):a=e.cours.$update(),s.length>0&&a.then(function(e){i(s,e)})}i(e.devoirs,null)}r.all(n).then(e.fermer)},!e.creneau.en_creation){e.estimation_over=function(e,t){e.overValue=t,e.minutes=5*t},e.estimation_leave=function(t){e.estimation_over(t,t.temps_estime)},e.devoirs=g.map(function(e){return f.get({id:e.id})}),e.types_de_devoir=d.query_types_de_devoir();var D=function(t){e.cours=p.get({id:t.id}),e.cours.$promise.then(function(t){e.cours.editable=_(e.cours.date_validation).isNull()&&e.cours.enseignant_id===e.current_user.uid,e.cours.editable||(e.cours.contenu=n.trustAsHtml(e.cours.contenu)),t.devoirs=_(t.devoirs).map(function(e){return f.get({id:e.id})}),_(t.devoirs).each(function(t){t.$promise.then(function(t){e.estimation_leave(t),t.tooltip=t.contenu,t.temps_estime>0&&(t.tooltip='<span><i class="picto temps"></i>'+5*t.temps_estime+" minutes</span><hr>"+t.tooltip),e.creneau.etranger&&(t.contenu=n.trustAsHtml(t.contenu))})}),r.all(e.devoirs).then(function(){e.cours.devoirs=_(e.cours.devoirs).filter(function(t){return _.chain(e.devoirs).findWhere({id:t.id}).isUndefined().value()})}),e.cours.$promise.then(function(){_(e.cours.ressources).each(function(e){e.url=n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+e.hash)})}),_(e.cours.devoirs).each(function(e){e.$promise.then(function(){_(e.ressources).each(function(e){e.url=n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+e.hash)})})})}),e.cours.create=!1};_(h).isNull()?e.creneau.etranger||(e.cours=m(v),e.cours.editable=!0):D(h),_(e.devoirs).each(function(t){t.$promise.then(function(){e.estimation_leave(t),_(t.ressources).each(function(e){e.url=n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+e.hash)}),e.creneau.etranger&&(t.contenu=n.trustAsHtml(t.contenu))})}),e.set_creneau_date_due=function(t){var r=_(e.creneaux_devoirs_possibles).findWhere({date_due:t.date_due});t.creneau_emploi_du_temps_id=r.creneau_emploi_du_temps_id,e.is_dirty()};var C=function(e,t){return d.get_creneaux_emploi_du_temps_similaires({id:e.id,debut:e.heure_debut,fin:moment(e.heure_debut.toISOString()).add(t,"weeks").toDate()})};C(e.creneau,12).then(function(r){e.creneaux_devoirs_possibles_duplication=[],e.creneaux_similaires=_.chain(r.data).reject(function(e){return"undefined"===e.regroupement_id}).reject(function(e){return e.has_cours}).map(function(t){return t.classe=_(e.classes).findWhere({id:parseInt(t.regroupement_id)}),t.heure_debut=new Date(t.heure_debut),t.heure_fin=new Date(t.heure_fin),t}).value(),e.creneaux_similaires.selected=[],e.creneaux_devoirs_possibles=_.chain(r.data).select(function(t){return t.regroupement_id==e.creneau.regroupement_id}).map(function(r){return r.classe=_(e.classes).findWhere({id:parseInt(r.regroupement_id)}),r.date_due=t("date")(r.start,"y-MM-dd"),r.semaine=moment(r.start).from(moment(e.creneau.heure_debut),!0)+" plus tard",r.heure_debut=new Date(r.heure_debut),r.heure_fin=new Date(r.heure_fin),r}).sortBy(function(e){return e.start}).value()}),e.cartable={},e.cartable.expandedNodes=[];var E=function(){e.erreurs.push({message:"Application Documents non disponible"}),e.faulty_docs_app=!0};c.list_files().success(function(t){_(t.error).isEmpty()?(e.cartable=t,e.cartable.files=_.chain(t.files).rest().value().map(function(e){return e.children=[],e})):E()}).error(E);var $=function(e){return!_(e.toString().match(/_+/)).isNull()},x=function(t){return function(r){e.erreurs=[],_(r.error).isEmpty()?$(_(r.added).first().hash)?(t.ressources.push({name:_(r.added).first().name,hash:_(r.added).first().hash,url:n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+_(r.added).first().hash)}),e.is_dirty()):e.erreurs.push({message:"L'identifiant retourné par l'application Documents n'est pas valide."}):e.erreurs.push({message:r.error})}};e.add_ressource=function(t,r,n){void 0===t.ressources&&(t.ressources=[]),void 0===_(t.ressources).findWhere({hash:n})&&c.ajout_au_cahier_de_textes(e.classe,n).success(x(t)).error(function(e){console.debug(e.error)})},e.upload_and_add_ressource=function(t,r){void 0===t.ressources&&(t.ressources=[]);for(var n=c.upload_dans_cahier_de_textes(e.classe,r),i=0;i<n.length;i++)n[i].success(x(t)).error(function(e){console.debug(e.error)})},e.remove_ressource=function(t,r){t.ressources=_(t.ressources).reject(function(e){return e.hash==r}),e.is_dirty()},e.treeClicked=function(t){"directory"===t.mime&&c.list_files(t.hash).then(function(r){_.chain(r.data.files).rest().each(function(e){e.children=[],t.children.push(e)}),e.cartable.expandedNodes=[],e.cartable.expandedNodes.push(_(e.cartable.files).findWhere(t))})},e.treeOptions={dirSelectable:!1},e.ajout_devoir=function(r,n){_(n).isNull()&&(n=e.creneau);var i=new f({cours_id:e.cours.id,date_due:t("date")(n.heure_debut,"yyyy-MM-dd"),type_devoir_id:_(e.types_de_devoir).last().id,creneau_emploi_du_temps_id:n.id});i.create=!0,r.unshift(i)},e.ok_go_for_duplication=!1,e.are_we_go_for_duplication=function(){e.ok_go_for_duplication=!_(e.creneaux_similaires.selected).isEmpty()&&_(e.cours.devoirs).reduce(function(e,t){return e&&_(t).has("creneau_cible")},!0)},e.creneau_cible_duplication_SP_updated=function(){C(e.creneaux_similaires.selected,4).then(function(r){e.creneaux_devoirs_possibles_duplication=_.chain(r.data).select(function(t){return t.regroupement_id==e.creneaux_similaires.selected.regroupement_id}).map(function(r){return r.classe=_(e.classes).findWhere({id:parseInt(r.regroupement_id)}),r.date_due=t("date")(r.start,"y-MM-dd"),r.semaine=moment(r.start).from(moment(e.creneau.heure_debut),!0)+" plus tard",r.heure_debut=new Date(r.heure_debut),r.heure_fin=new Date(r.heure_fin),r}).value()}),e.are_we_go_for_duplication()},e.dupliquer=function(){var t=angular.copy(e.cours.devoirs);e.cours.$copie({regroupement_id:e.creneaux_similaires.selected.regroupement_id,creneau_emploi_du_temps_id:e.creneaux_similaires.selected.creneau_emploi_du_temps_id,date:e.creneaux_similaires.selected.start}).then(function(){_(t).each(function(t){t.$copie({cours_id:e.cours.copie_id,creneau_emploi_du_temps_id:t.creneau_cible.id,date_due:t.creneau_cible.date_due}).then(function(){t.creneau_cible=[]})}),e.creneaux_similaires=_(e.creneaux_similaires).reject(function(t){return t.id+t.start==e.creneaux_similaires.selected.id+e.creneaux_similaires.selected.start}),e.creneaux_similaires.selected=[],D(e.cours)})},e.effacer_cours=function(){e.cours.$delete().then(function(){D(e.cours)})},e.effacer_devoir=function(e){_(e).has("id")?e.$delete():e.deleted=!0},e.switch_to_duplication_mode=function(){e.mode_duplication=!0},e.switch_to_modification_mode=function(){e.creneau.en_creation=!1,e.mode_duplication=!1},e.switch_to_creneau_edition=function(){e.erreurs=[],e.creneau.en_creation=!0}}})}]),angular.module("cahierDeTexteApp").controller("CahierDeTextesCtrl",["$scope","$sce","$q","APP_PATH","DOCS_URL","API","Annuaire","EmploisDuTemps","current_user","PopupsCreneau","CreneauEmploiDuTemps",function(e,t,r,n,i,a,s,u,o,c,d){e.current_user=o;var l=[],p=[],f=!1;e.scope=e,e.selected_regroupement_id=null,e.selected_creneau_vide=null;var m=function(t){var r=_.chain(t).filter(function(t){return t.enseignant_id===e.current_user.uid}).reject(function(e){return _(e.cours).isEmpty()}).map(function(e){return e.devoirs.ouvert=!0,e}).value();return r},h=function(t){var r=_.chain(t).filter(function(t){return t.enseignant_id===e.current_user.uid}).filter(function(e){return _(e.cours).isEmpty()}).value();return r},g=function(e){return _.chain(e).pluck("matiere_id").uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return[e,s.get_matiere(e)]}).object().value()};e.period_offset=e.current_user.date?moment(moment()-moment(e.current_user.date)).months():0,e.$watch("period_offset",function(){v()}),e.incr_offset=function(){e.period_offset++},e.decr_offset=function(){e.period_offset--},e.reset_offset=function(){e.period_offset=0};var v=function(){e.current_user.date=moment().subtract(e.period_offset,"months").toDate(),e.from_date=moment(e.current_user.date).subtract(2,"weeks").startOf("week").toDate(),e.to_date=moment(e.current_user.date).add(2,"weeks").endOf("week").toDate(),u.query({debut:e.from_date,fin:e.to_date,uai:e.current_user.profil_actif.uai}).$promise.then(function(r){e.raw_data=r,l=g(e.raw_data),_(e.raw_data).each(function(e){e.matiere=s.get_matiere(e.matiere_id),e.regroupement=s.get_regroupement(e.regroupement_id)}),e.creneaux_vides=h(e.raw_data),e.creneaux_saisies=m(e.raw_data),_(e.creneaux_saisies).each(function(e){_(e.cours.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)
}),_(e.devoirs).each(function(e){_(e.ressources).each(function(e){e.url=t.trustAsResourceUrl(i+"/api/connector?cmd=file&target="+e.hash)})})}),e.selected_creneau_vide=null})};e.popup_callback=v,e.edition_creneau=function(t){d.get({id:t.creneau_emploi_du_temps_id}).$promise.then(function(r){r.dirty=!1,r.heure_debut=new Date(t.start),r.heure_fin=new Date(t.end),r.regroupement_id=t.regroupement_id,c.edition(e.raw_data,p,e.classes,r,t.cours,t.devoirs,e.popup_callback,f)})},p=e.current_user.profil_actif.matieres,e.classes=e.current_user.profil_actif.classes}]),angular.module("cahierDeTexteApp").controller("IndexCtrl",["Redirection",function(e){e.doorman([])}]),angular.module("cahierDeTexteApp").controller("PrincipalClassesCtrl",["$scope","THEME","$locale","$q","API","Annuaire","current_user","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,r,n,i,a,s,u,o){e.empty=!1,e.scope=e,e.raw_data=[],e.displayed_data=[],e.classes={},e.matieres=[],e.annee=_(r.DATETIME_FORMATS.MONTH).toArray(),e.selected_regroupement_id=null,e.selected_mois=null,e.selected_matiere=null,e.global_stats={filled:0,validated:0},e.pieChart=u(),e.barChart=o(),e.pieChart.populate=function(t){e.pieChart.data=[{label:"saisie",value:t.filled-t.validated},{label:"valide",value:t.validated}]},e.barChart.populate=function(t){var r=[];_(12).times(function(t){r.push([e.annee[t],0])});var n=t.reduce(function(e,t){return _(12).times(function(r){e.filled[r][1]+=t.mensuel.filled[r],e.validated[r][1]+=t.mensuel.validated[r]}),e},{filled:angular.copy(r),validated:angular.copy(r)});e.barChart.data=[],e.barChart.data.push({key:"saisie",values:n.filled}),e.barChart.data.push({key:"valide",values:n.validated})},e.individualCharts={classes:[],populate:function(t,r){var n=_.chain(r).map(function(e){return[e.id,e]}).object().value();e.individualCharts.classes=_(t).map(function(e){var t={regroupement:n[e.regroupement_id],pieChart:u()};return t.pieChart.data=[{label:"saisie",value:e.filled-e.validated},{label:"valide",value:e.validated}],t})}},e.extract_matieres=function(e){return _.chain(e).pluck("matieres").flatten().pluck("matiere_id").uniq().compact().map(function(e){var t={id:e,libelle:"Matière inconnue !"};return a.get_matiere(e).$promise.then(function(e){t.libelle=e.libelle_long}),t}).value()},e.extract_classes=function(e){return _.chain(e).pluck("regroupement_id").map(function(e){return a.get_regroupement(e).$promise}).value()},e.process_data=function(){if(e.raw_data.length>0){e.displayed_data=e.raw_data,null!=e.selected_matiere&&(e.displayed_data=e.displayed_data.map(function(t){var r=_(t.matieres).filter(function(t){return t.matiere_id==e.selected_matiere});return{regroupement_id:t.regroupement_id,matieres:r}})),null!=e.selected_mois&&(e.displayed_data=e.displayed_data.map(function(t){return{regroupement_id:t.regroupement_id,matieres:t.matieres.map(function(t){return{matiere_id:t.matiere_id,mois:_(t.mois).filter(function(t){return t.mois==e.selected_mois})}})}})),_(e.displayed_data).each(function(e){e.mensuel=e.matieres.reduce(function(e,t){return _(t.mois).each(function(t){e.filled[t.mois-1]+=t.filled,e.validated[t.mois-1]+=t.validated}),e},{filled:[0,0,0,0,0,0,0,0,0,0,0,0],validated:[0,0,0,0,0,0,0,0,0,0,0,0]}),e.filled=e.mensuel.filled.reduce(function(e,t){return e+t},0),e.validated=e.mensuel.validated.reduce(function(e,t){return e+t},0)});var t=e.displayed_data.reduce(function(e,t){return{filled:e.filled+t.filled,validated:e.validated+t.validated}},{filled:0,validated:0});e.displayed_data.filled=t.filled,e.displayed_data.validated=t.validated,e.individualCharts.populate(e.displayed_data,e.classes),e.pieChart.populate(e.displayed_data),e.barChart.populate(e.displayed_data)}},i.query_classes({uai:s.profil_actif.uai}).$promise.then(function(t){e.raw_data=t,e.empty=0==_(e.raw_data[0]).size(),e.empty||n.all(e.extract_matieres(e.raw_data)).then(function(t){e.matieres=t,n.all(e.extract_classes(e.raw_data)).then(function(t){e.classes=t,e.process_data()})})})}]),angular.module("cahierDeTexteApp").controller("PopupEditionCtrl",["$scope","$filter","$q","$sce","$modalInstance","APP_PATH","DOCS_URL","SEMAINES_VACANCES","ZONE","Documents","API","CreneauEmploiDuTemps","Cours","Devoirs","User","cours","devoirs","creneau","raw_data","classes","matieres",function(e,t,r,n,i,a,s,u,o,c,d,l,p,f,m,h,g,v,y,b,A){e.app_path=a,e.DOCS_URL_login=n.trustAsResourceUrl(s+"/login"),e.ZONE=o,e.faulty_docs_app=!1,e.erreurs=[],e.dirty=!1,e.mode_duplication=!1,e.scope=e,m.get_user().then(function(a){e.current_user=a.data;var m=function(t){var r=new p({creneau_emploi_du_temps_id:t.id,date_cours:new Date(t.heure_debut).toISOString(),date_validation:null,enseignant_id:e.current_user.uid,contenu:""});return r.devoirs=[],r.create=!0,r};e.is_dirty=function(t){t="undefined"!=typeof t?t:null,e.dirty=e.dirty||null===t||null!==t&&t.contenu.length>0},e.classes=b,e.matieres=A,e.creneau=v,e.creneau.en_creation=_(e.creneau.matiere_id).isEmpty()||"undefined"===e.creneau.regroupement_id,e.creneau.etranger=!e.creneau.en_creation&&!_.chain(e.creneau.enseignants).pluck("enseignant_id").include(e.current_user.uid).value(),e.creneau.previous_regroupement_id=e.creneau.regroupement_id,_(v.vierge).isUndefined()&&(v.vierge=!0),e.creneau.en_creation?(e.creneau.tmp_heure_debut=t("correctTimeZoneToGMT")(e.creneau.heure_debut),e.creneau.tmp_heure_fin=t("correctTimeZoneToGMT")(e.creneau.heure_fin),e.classe=_(e.classes).first(),e.matiere=_(e.matieres).first()):(e.creneau.tmp_heure_debut=angular.copy(e.creneau.heure_debut),e.creneau.tmp_heure_fin=angular.copy(e.creneau.heure_fin),e.classe=_(e.classes).findWhere({id:parseInt(e.creneau.regroupement_id)}),e.matiere=_(e.matieres).findWhere({id:e.creneau.matiere_id})),e.creneau.n_week=moment(e.creneau.tmp_heure_debut).week();var y=function(e){var t=e.toString(2),r="";return _(53-t.length).times(function(){r+="0"}),t=r+t,_(t.split("").map(function(e){return parseInt(e)}).reverse()).rest()},T=function(e){return parseInt(e.reverse().join("")+"0",2)};e.sont_ce_les_vacances=function(e,t){return-1!=u[t].indexOf(e)};var P=function(){var t=[];return _(52).times(function(r){t.push(e.sont_ce_les_vacances(r+1,o)?0:1)}),t};if(e.semaines_actives={regroupement:[]},e.apply_template=function(t){var r=[];switch(t){case"tout":e.semaines_actives.regroupement=P();break;case"rien":_(52).times(function(){r.push(0)}),e.semaines_actives.regroupement=r;break;case"paires":_(52).times(function(t){r.push(e.sont_ce_les_vacances(t+1,o)||(t+1)%2!=0?0:1)}),e.semaines_actives.regroupement=r;break;case"impaires":_(52).times(function(t){r.push(e.sont_ce_les_vacances(t+1,o)||(t+1)%2!=1?0:1)}),e.semaines_actives.regroupement=r;break;case"unique":_(52).times(function(t){r.push(t+1==e.creneau.n_week?1:0)}),e.semaines_actives.regroupement=r;break;case"inverser":e.semaines_actives.regroupement=_(e.semaines_actives.regroupement).map(function(t,r){return 0!=t||e.sont_ce_les_vacances(r+1,o)?0:1});break;case"reinitialiser":e.semaines_actives.regroupement=e.creneau.en_creation?P():y(_(v.regroupements).findWhere({regroupement_id:v.regroupement_id}).semaines_de_presence)}},e.apply_template("reinitialiser"),e.fermer=function(){i.close(e)},e.effacer_creneau=function(){swal({title:"Ceci supprimera le créneau à compter du "+t("date")(v.heure_debut,"fullDate"),text:"Le créneau avec ses séquences pédagogiques et devoirs associés restera visible pour les dates antérieures.",type:"warning",showCancelButton:!0,confirmButtonColor:"#ff6b55",confirmButtonText:"Confirmer",cancelButtonText:"Annuler"},function(){l.delete({id:e.creneau.id,date_creneau:e.creneau.heure_debut}).$promise.then(function(){e.fermer()})})},e.annuler=function(){e.creneau.en_creation&&_(e.creneau.matiere_id).isEmpty()&&"undefined"===e.creneau.regroupement_id?e.effacer_creneau():(e.dirty=!1,e.fermer())},e.valider=function(){e.erreurs=[];var n=[];if(e.creneau.en_creation)e.creneau.matiere_id=e.matiere.id,e.creneau.regroupement_id=e.classe.id,e.creneau.heure_debut=t("correctTimeZone")(e.creneau.tmp_heure_debut),e.creneau.heure_fin=t("correctTimeZone")(e.creneau.tmp_heure_fin),e.creneau.semaines_de_presence_regroupement=T(e.semaines_actives.regroupement),e.creneau.$update();else{var i=function(t,i){_(t).each(function(t){if(_(t).has("contenu")&&t.contenu.length>0){var a=r.defer();t.create?(t.regroupement_id=e.classe.id,_(i).isNull()||(t.cours_id=i.id),t.$save().then(function(e){t.id=e.id,a.resolve(e)},function(t){e.erreurs.unshift({status:t.status,message:t.data.error}),a.reject(t)})):t.$update().then(function(e){t.id=e.id,a.resolve(e)},function(t){e.erreurs.unshift({status:t.status,message:t.data.error}),a.reject(t)}),n.push(a.promise)}})};if(_(e.cours).has("contenu")&&e.cours.contenu.length>0||e.cours.devoirs.length>0){var a=r.when(!0),s=_(e.cours.devoirs).map(function(e){return new f(e)});e.cours.create?(e.cours.regroupement_id=e.classe.id,e.cours.creneau_emploi_du_temps_id=e.creneau.id,a=e.cours.$save()):a=e.cours.$update(),s.length>0&&a.then(function(e){i(s,e)})}i(e.devoirs,null)}r.all(n).then(e.fermer)},!e.creneau.en_creation){e.estimation_over=function(e,t){e.overValue=t,e.minutes=5*t},e.estimation_leave=function(t){e.estimation_over(t,t.temps_estime)},e.devoirs=g.map(function(e){return f.get({id:e.id})}),e.types_de_devoir=d.query_types_de_devoir();var D=function(t){e.cours=p.get({id:t.id}),e.cours.$promise.then(function(t){e.cours.editable=_(e.cours.date_validation).isNull()&&e.cours.enseignant_id===e.current_user.uid,e.cours.editable||(e.cours.contenu=n.trustAsHtml(e.cours.contenu)),t.devoirs=_(t.devoirs).map(function(e){return f.get({id:e.id})}),_(t.devoirs).each(function(t){t.$promise.then(function(t){e.estimation_leave(t),t.tooltip=t.contenu,t.temps_estime>0&&(t.tooltip='<span><i class="picto temps"></i>'+5*t.temps_estime+" minutes</span><hr>"+t.tooltip),e.creneau.etranger&&(t.contenu=n.trustAsHtml(t.contenu))})}),r.all(e.devoirs).then(function(){e.cours.devoirs=_(e.cours.devoirs).filter(function(t){return _.chain(e.devoirs).findWhere({id:t.id}).isUndefined().value()})}),e.cours.$promise.then(function(){_(e.cours.ressources).each(function(e){e.url=n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+e.hash)})}),_(e.cours.devoirs).each(function(e){e.$promise.then(function(){_(e.ressources).each(function(e){e.url=n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+e.hash)})})})}),e.cours.create=!1};_(h).isNull()?e.creneau.etranger||(e.cours=m(v),e.cours.editable=!0):D(h),_(e.devoirs).each(function(t){t.$promise.then(function(){e.estimation_leave(t),_(t.ressources).each(function(e){e.url=n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+e.hash)}),e.creneau.etranger&&(t.contenu=n.trustAsHtml(t.contenu))})}),e.set_creneau_date_due=function(t){var r=_(e.creneaux_devoirs_possibles).findWhere({date_due:t.date_due});t.creneau_emploi_du_temps_id=r.creneau_emploi_du_temps_id,e.is_dirty()};var C=function(e,t){return d.get_creneaux_emploi_du_temps_similaires({id:e.id,debut:e.heure_debut,fin:moment(e.heure_debut.toISOString()).add(t,"weeks").toDate()})};C(e.creneau,12).then(function(r){e.creneaux_devoirs_possibles_duplication=[],e.creneaux_similaires=_.chain(r.data).reject(function(e){return"undefined"===e.regroupement_id}).reject(function(e){return e.has_cours}).map(function(t){return t.classe=_(e.classes).findWhere({id:parseInt(t.regroupement_id)}),t.heure_debut=new Date(t.heure_debut),t.heure_fin=new Date(t.heure_fin),t}).value(),e.creneaux_similaires.selected=[],e.creneaux_devoirs_possibles=_.chain(r.data).select(function(t){return t.regroupement_id==e.creneau.regroupement_id}).map(function(r){return r.classe=_(e.classes).findWhere({id:parseInt(r.regroupement_id)}),r.date_due=t("date")(r.start,"y-MM-dd"),r.semaine=moment(r.start).from(moment(e.creneau.heure_debut),!0)+" plus tard",r.heure_debut=new Date(r.heure_debut),r.heure_fin=new Date(r.heure_fin),r}).sortBy(function(e){return e.start}).value()}),e.cartable={},e.cartable.expandedNodes=[];var E=function(){e.erreurs.push({message:"Application Documents non disponible"}),e.faulty_docs_app=!0};c.list_files().success(function(t){_(t.error).isEmpty()?(e.cartable=t,e.cartable.files=_.chain(t.files).rest().value().map(function(e){return e.children=[],e})):E()}).error(E);var $=function(e){return!_(e.toString().match(/_+/)).isNull()},x=function(t){return function(r){e.erreurs=[],_(r.error).isEmpty()?$(_(r.added).first().hash)?(t.ressources.push({name:_(r.added).first().name,hash:_(r.added).first().hash,url:n.trustAsResourceUrl(s+"/api/connector?cmd=file&target="+_(r.added).first().hash)}),e.is_dirty()):e.erreurs.push({message:"L'identifiant retourné par l'application Documents n'est pas valide."}):e.erreurs.push({message:r.error})}};e.add_ressource=function(t,r,n){void 0===t.ressources&&(t.ressources=[]),void 0===_(t.ressources).findWhere({hash:n})&&c.ajout_au_cahier_de_textes(e.classe,n).success(x(t)).error(function(e){console.debug(e.error)})},e.upload_and_add_ressource=function(t,r){void 0===t.ressources&&(t.ressources=[]);for(var n=c.upload_dans_cahier_de_textes(e.classe,r),i=0;i<n.length;i++)n[i].success(x(t)).error(function(e){console.debug(e.error)})},e.remove_ressource=function(t,r){t.ressources=_(t.ressources).reject(function(e){return e.hash==r}),e.is_dirty()},e.treeClicked=function(t){"directory"===t.mime&&c.list_files(t.hash).then(function(r){_.chain(r.data.files).rest().each(function(e){e.children=[],t.children.push(e)}),e.cartable.expandedNodes=[],e.cartable.expandedNodes.push(_(e.cartable.files).findWhere(t))})},e.treeOptions={dirSelectable:!1},e.ajout_devoir=function(r,n){_(n).isNull()&&(n=e.creneau);var i=new f({cours_id:e.cours.id,date_due:t("date")(n.heure_debut,"yyyy-MM-dd"),type_devoir_id:_(e.types_de_devoir).last().id,creneau_emploi_du_temps_id:n.id});i.create=!0,r.unshift(i)},e.ok_go_for_duplication=!1,e.are_we_go_for_duplication=function(){e.ok_go_for_duplication=!_(e.creneaux_similaires.selected).isEmpty()&&_(e.cours.devoirs).reduce(function(e,t){return e&&_(t).has("creneau_cible")},!0)},e.creneau_cible_duplication_SP_updated=function(){C(e.creneaux_similaires.selected,4).then(function(r){e.creneaux_devoirs_possibles_duplication=_.chain(r.data).select(function(t){return t.regroupement_id==e.creneaux_similaires.selected.regroupement_id}).map(function(r){return r.classe=_(e.classes).findWhere({id:parseInt(r.regroupement_id)}),r.date_due=t("date")(r.start,"y-MM-dd"),r.semaine=moment(r.start).from(moment(e.creneau.heure_debut),!0)+" plus tard",r.heure_debut=new Date(r.heure_debut),r.heure_fin=new Date(r.heure_fin),r}).value()}),e.are_we_go_for_duplication()},e.dupliquer=function(){var t=angular.copy(e.cours.devoirs);e.cours.$copie({regroupement_id:e.creneaux_similaires.selected.regroupement_id,creneau_emploi_du_temps_id:e.creneaux_similaires.selected.creneau_emploi_du_temps_id,date:e.creneaux_similaires.selected.start}).then(function(){_(t).each(function(t){t.$copie({cours_id:e.cours.copie_id,creneau_emploi_du_temps_id:t.creneau_cible.id,date_due:t.creneau_cible.date_due}).then(function(){t.creneau_cible=[]})}),e.creneaux_similaires=_(e.creneaux_similaires).reject(function(t){return t.id+t.start==e.creneaux_similaires.selected.id+e.creneaux_similaires.selected.start}),e.creneaux_similaires.selected=[],D(e.cours)})},e.effacer_cours=function(){e.cours.$delete().then(function(){D(e.cours)})},e.effacer_devoir=function(e){_(e).has("id")?e.$delete():e.deleted=!0},e.switch_to_duplication_mode=function(){e.mode_duplication=!0},e.switch_to_modification_mode=function(){e.creneau.en_creation=!1,e.mode_duplication=!1},e.switch_to_creneau_edition=function(){e.erreurs=[],e.creneau.en_creation=!0}}})}]),angular.module("cahierDeTexteApp").controller("EleveCtrl",["$scope","$state","$stateParams","current_user",function(e,t,r,n){e.tabs=[{heading:"Emploi du temps",uisref:"eleve.emploi_du_temps",active:!1},{heading:"Liste des devoirs",uisref:"eleve.devoirs",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name}),e.current_user=n,e.reload=function(){t.transitionTo(t.current,r,{reload:!0,inherit:!0,notify:!0})}}]),angular.module("cahierDeTexteApp").controller("VieScolaireCtrl",["$scope","$state",function(e,t){e.tabs=[{heading:"Emplois du Temps",uisref:"principal.emploi_du_temps",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name})}]),angular.module("cahierDeTexteApp").controller("PrincipalCtrl",["$scope","$state",function(e,t){e.tabs=[{heading:"Validation des saisies par enseignant",uisref:"principal.enseignants",active:!1},{heading:"Tableaux de bord par classe",uisref:"principal.classes",active:!1},{heading:"Emplois du Temps",uisref:"principal.emploi_du_temps",active:!1},{heading:"Import Pronote",uisref:"principal.import",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name})}]),angular.module("cahierDeTexteApp").controller("FooterCtrl",["$scope","$state","$stateParams","VERSION","User",function(e,t,r,n,i){e.version=n,i.get_user().then(function(n){e.current_user=n.data,e.save_and_reload=function(){i.update_parameters(e.current_user.parametrage_cahier_de_textes).success(function(){t.transitionTo(t.current,r,{reload:!0,inherit:!0,notify:!0})})}})}]),angular.module("cahierDeTexteApp").controller("StatsEnseignantCtrl",["$scope","$stateParams","$q","$locale","API","Cours","Annuaire","current_user","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,r,n,i,a,s,u,o,c){e.mois=_(n.DATETIME_FORMATS.MONTH).toArray(),e.scope=e,e.classe=null,e.moisCourant=null,e.matieres={},e.classes={},e.montre_valides=!1;var d=function(t,r,n){var i=t;if("DIR"===e.current_user.profil_actif.profil_id){var a=moment().subtract(2,"weeks");i=_(i).select(function(e){return moment(e.cours.date_cours).isBefore(a)})}return null!=r&&(i=_(i).where({mois:r})),null!=n&&(i=_(i).where({regroupement_id:n.id})),i};e.valide=function(e){e.cours.$valide()},e.valide_all=function(){swal({title:"Tout valider ?",text:"Cette action va valider toutes les saisies actuellement affichées à l'écran.",type:"warning",showCancelButton:!0,confirmButtonColor:"#ff6b55",confirmButtonText:"Confirmer",cancelButtonText:"Annuler"},function(){_.chain(e.raw_data).reject(function(e){return e.valide}).each(function(t){e.valide(t),t.valide=!0})})},e.graphiques={pieChart:o(),barChart:c(),populate:function(t){e.graphiques.barChart.data=[],e.graphiques.pieChart.data=[{label:"visas",value:0},{label:"saisies",value:0}];var r={key:"saisies",values:[]},n={key:"visas",values:[]};_.chain(d(t,e.moisCourant,e.classe)).groupBy("regroupement_id").each(function(t){var i=t.length,a=_(t).where({valide:!0}).length;r.values.push([e.classes[t[0].regroupement_id].libelle,i]),n.values.push([e.classes[t[0].regroupement_id].libelle,a]),e.graphiques.barChart.data=[n,r],e.graphiques.pieChart.data[0].value+=a,e.graphiques.pieChart.data[1].value+=i-a})}},e.process_data=function(){void 0!==e.raw_data&&(e.raw_data=_(e.raw_data).map(function(e,t){return e.index=t,e.cours=new a(e.cours),e}),e.graphiques.populate(e.raw_data))},e.current_user=u,e.enseignant_id=t.enseignant_id,void 0===e.enseignant_id&&e.enseignant_id!=e.current_user.uid&&(e.enseignant_id=e.current_user.uid),s.get_user(e.enseignant_id).$promise.then(function(t){e.enseignant=t,e.enseignant.liste_classes=_(e.enseignant.classes).uniq(function(e){return e.classe_libelle}),e.enseignant.liste_matieres=_.chain(e.enseignant.classes).pluck("matiere_libelle").uniq().value(),e.enseignant.prof_principal=_.chain(e.enseignant.classes).filter(function(e){return"O"==e.prof_principal}).map(function(e){return e.classe_libelle}).value()}),i.get_enseignant({enseignant_id:e.enseignant_id,uai:e.current_user.profil_actif.uai}).$promise.then(function(t){var n=function(e,t,r){return _.chain(e).flatten().pluck(t).uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return r(e)}).object().value()};e.raw_data=t.saisies,e.matieres=n(e.raw_data,"matiere_id",function(e){return[e,s.get_matiere(e)]}),e.classes=n(e.raw_data,"regroupement_id",function(e){return[e,s.get_regroupement(e)]}),r.all(e.classes).then(function(){e.process_data()})})}]),angular.module("cahierDeTexteApp").controller("EnseignantCtrl",["$scope","$state","current_user",function(e,t,r){e.tabs=[{heading:"Emploi du temps",uisref:"enseignant.emploi_du_temps",active:!1},{heading:"Cahier de textes",uisref:"enseignant.cahier_de_textes",active:!1},{heading:"Statistiques",uisref:"enseignant.stats",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name}),e.current_user=r}]),angular.module("cahierDeTexteApp").controller("EleveCtrl",["$scope","$state","$stateParams","current_user",function(e,t,r,n){e.tabs=[{heading:"Emploi du temps",uisref:"eleve.emploi_du_temps",active:!1},{heading:"Liste des devoirs",uisref:"eleve.devoirs",active:!1}],_(e.tabs).each(function(e){e.active=e.uisref==t.current.name}),e.current_user=n,e.reload=function(){t.transitionTo(t.current,r,{reload:!0,inherit:!0,notify:!0})}}]),angular.module("cahierDeTexteApp").controller("StatsEnseignantCtrl",["$scope","$stateParams","$q","$locale","API","Cours","Annuaire","current_user","PIECHART_DEFINITION","BARCHART_DEFINITION",function(e,t,r,n,i,a,s,u,o,c){e.mois=_(n.DATETIME_FORMATS.MONTH).toArray(),e.scope=e,e.classe=null,e.moisCourant=null,e.matieres={},e.classes={},e.montre_valides=!1;var d=function(t,r,n){var i=t;if("DIR"===e.current_user.profil_actif.profil_id){var a=moment().subtract(2,"weeks");i=_(i).select(function(e){return moment(e.cours.date_cours).isBefore(a)})}return null!=r&&(i=_(i).where({mois:r})),null!=n&&(i=_(i).where({regroupement_id:n.id})),i};e.valide=function(e){e.cours.$valide()},e.valide_all=function(){swal({title:"Tout valider ?",text:"Cette action va valider toutes les saisies actuellement affichées à l'écran.",type:"warning",showCancelButton:!0,confirmButtonColor:"#ff6b55",confirmButtonText:"Confirmer",cancelButtonText:"Annuler"},function(){_.chain(e.raw_data).reject(function(e){return e.valide}).each(function(t){e.valide(t),t.valide=!0})})},e.graphiques={pieChart:o(),barChart:c(),populate:function(t){e.graphiques.barChart.data=[],e.graphiques.pieChart.data=[{label:"visas",value:0},{label:"saisies",value:0}];var r={key:"saisies",values:[]},n={key:"visas",values:[]};_.chain(d(t,e.moisCourant,e.classe)).groupBy("regroupement_id").each(function(t){var i=t.length,a=_(t).where({valide:!0}).length;r.values.push([e.classes[t[0].regroupement_id].libelle,i]),n.values.push([e.classes[t[0].regroupement_id].libelle,a]),e.graphiques.barChart.data=[n,r],e.graphiques.pieChart.data[0].value+=a,e.graphiques.pieChart.data[1].value+=i-a})}},e.process_data=function(){void 0!==e.raw_data&&(e.raw_data=_(e.raw_data).map(function(e,t){return e.index=t,e.cours=new a(e.cours),e}),e.graphiques.populate(e.raw_data))},e.current_user=u,e.enseignant_id=t.enseignant_id,void 0===e.enseignant_id&&e.enseignant_id!=e.current_user.uid&&(e.enseignant_id=e.current_user.uid),s.get_user(e.enseignant_id).$promise.then(function(t){e.enseignant=t,e.enseignant.liste_classes=_(e.enseignant.classes).uniq(function(e){return e.classe_libelle}),e.enseignant.liste_matieres=_.chain(e.enseignant.classes).pluck("matiere_libelle").uniq().value(),e.enseignant.prof_principal=_.chain(e.enseignant.classes).filter(function(e){return"O"==e.prof_principal}).map(function(e){return e.classe_libelle}).value()}),i.get_enseignant({enseignant_id:e.enseignant_id,uai:e.current_user.profil_actif.uai}).$promise.then(function(t){var n=function(e,t,r){return _.chain(e).flatten().pluck(t).uniq().compact().reject(function(e){return"undefined"===e}).map(function(e){return r(e)}).object().value()};e.raw_data=t.saisies,e.matieres=n(e.raw_data,"matiere_id",function(e){return[e,s.get_matiere(e)]}),e.classes=n(e.raw_data,"regroupement_id",function(e){return[e,s.get_regroupement(e)]}),r.all(e.classes).then(function(){e.process_data()})})}]),angular.module("cahierDeTexteApp").controller("HeaderCtrl",["$scope","$state","User","Redirection",function(e,t,r,n){e.embedded=window!=window.top,r.get_user().success(function(t){e.current_user=t}),e.reload=function(){n.doorman([])}}]),angular.module("cahierDeTexteApp").filter("correctTimeZone",function(){return function(e){var t=6e4*new Date(e).getTimezoneOffset();return new Date(new Date(e)-t)}}).filter("correctTimeZoneToGMT",function(){return function(e){var t=new Date(e).getTimezoneOffset()/60;return e.setHours(e.getHours()+t),e}}).filter("formateCreneau",["$filter",function(e){return function(t){return e("date")(t.start,"EEE dd MMM HH:mm")+" - "+e("date")(t.end,"shortTime")}}]),angular.module("cahierDeTexteApp").filter("correctTimeZone",function(){return function(e){var t=6e4*new Date(e).getTimezoneOffset();return new Date(new Date(e)-t)}}).filter("correctTimeZoneToGMT",function(){return function(e){var t=new Date(e).getTimezoneOffset()/60;return e.setHours(e.getHours()+t),e}}).filter("formateCreneau",["$filter",function(e){return function(t){return e("date")(t.start,"EEE dd MMM HH:mm")+" - "+e("date")(t.end,"shortTime")}}]);